<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M5121 ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'ë§‘ì€ ê³ ë”•','Malgun Gothic',Arial,sans-serif;font-size:16px;background:#f0f2f5;color:#1a1a1a;min-height:100vh;}
/* â”€â”€ HEADER â”€â”€ */
.app-header{background:#1a3a6b;color:#fff;padding:10px 18px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.app-logo{font-size:26px;font-weight:900;letter-spacing:-1px;}
.app-sub{font-size:15px;color:#aaccff;margin-top:1px;}
.month-nav{display:flex;align-items:center;gap:8px;margin-left:auto;}
.month-nav button{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;padding:6px 13px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:bold;}
.month-nav button:hover{background:rgba(255,255,255,.25);}
.month-display{font-size:22px;font-weight:bold;min-width:120px;text-align:center;}
/* â”€â”€ TABS â”€â”€ */
.tab-bar{background:#fff;border-bottom:2px solid #d0d8e4;display:flex;overflow-x:auto;}
.tab-btn{padding:11px 18px;border:none;background:none;cursor:pointer;font-size:16px;font-weight:600;color:#555;border-bottom:3px solid transparent;white-space:nowrap;transition:all .15s;}
.tab-btn:hover{background:#f0f5ff;color:#1a3a6b;}
.tab-btn.active{color:#1a3a6b;border-bottom-color:#1a3a6b;background:#f5f8ff;}
/* â”€â”€ TABS CONTENT â”€â”€ */
.tab-content{display:none;padding:14px;overflow-x:auto;}
.tab-content.active{display:block;}
/* â”€â”€ TOP-BAR â”€â”€ */
.top-bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center;}
.top-bar-title{font-size:18px;font-weight:bold;color:#1a3a6b;}
/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:9px 16px;border-radius:5px;border:none;cursor:pointer;font-size:15px;font-weight:600;transition:opacity .15s,transform .1s;}
.btn:hover{opacity:.87;transform:translateY(-1px);}
.btn:active{transform:translateY(0);}
.btn-primary{background:#1a3a6b;color:#fff;}
.btn-success{background:#1e7e34;color:#fff;}
.btn-info{background:#0d7fb8;color:#fff;}
.btn-warning{background:#e07800;color:#fff;}
.btn-danger{background:#c0392b;color:#fff;}
.btn-secondary{background:#607080;color:#fff;}
.btn-light{background:#e8ecf2;color:#333;border:1px solid #ccc;}
.btn-sm{padding:5px 11px;font-size:14px;}
/* â”€â”€ FOOTER â”€â”€ */
.app-footer{position:sticky;bottom:0;background:#fff;border-top:2px solid #d0d8e4;padding:9px 14px;display:flex;gap:8px;flex-wrap:wrap;z-index:99;box-shadow:0 -2px 8px rgba(0,0,0,.1);}
/* â”€â”€ SCHEDULE TABLE â”€â”€ */
.sched-wrap{overflow:auto;max-height:calc(100vh - 180px);border:1px solid #c0c8d4;border-radius:6px;}
.sched-table thead th{position:sticky;z-index:10;}
.sched-table thead tr:first-child th{top:0;}
.sched-table thead tr:nth-child(2) th{top:30px;}
.sched-table{border-collapse:separate;border-spacing:0;font-size:14px;white-space:nowrap;}
.sched-table th,.sched-table td{border:1px solid #b0b8c8;padding:3px 5px;text-align:center;}
.sched-table .th-main{background:#1a3a6b;color:#fff;font-weight:700;padding:5px 7px;}
.sched-table .th-sub{background:#2d5a9e;color:#fff;}
.sched-table .th-day{background:#3a70b8;color:#fff;min-width:28px;}
.sched-table .th-sat{background:#3a5898;color:#adf;}
.sched-table .th-sun{background:#7a3030;color:#fdd;}
.sched-table .col-seq{background:#e8edf5;font-weight:bold;width:32px;}
.sched-table .col-veh{background:#e8edf5;width:46px;}
.sched-table .col-name{text-align:left;padding-left:7px;min-width:58px;}
.sched-table .col-info{background:#eef1f6;font-size:13px;}
.day-cell{cursor:pointer;min-width:28px;transition:background .1s;}
.day-cell:hover{background:#cce0ff!important;outline:2px solid #1a7fe8;}
.cell-work{background:#fff;color:#1a1a1a;font-weight:600;}
.cell-off{background:#fffacd;color:#7a6000;font-weight:600;}
.cell-pre-off{background:#fff9c4!important;}
.cell-su{background:#e8ffe8;color:#1a7a1a;font-weight:700;}
.cell-sat{background:#f0f5ff;}
.cell-sun{background:#fff5f5;}
.cell-hol{background:#f9a825!important;}
.cell-selected{outline:3px solid #ff7700!important;background:#fff5e0!important;}
.cell-note{background:#fffbe0!important;}
.cell-dup{background:#ffdddd!important;outline:2px solid red!important;}
.row-even td{background-color:rgba(240,245,255,.5);}
/* summary cells */
.sum-cell{background:#e8edf5;font-weight:700;font-size:14px;}
.over-cell{background:#fff3e0;color:#b05000;font-weight:700;}
.under-cell{background:#fce4ec;color:#a00;font-weight:700;}
/* â”€â”€ MODAL â”€â”€ */
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal-box{background:#fff;border-radius:10px;padding:22px;max-width:520px;width:92%;max-height:85vh;overflow-y:auto;box-shadow:0 8px 40px rgba(0,0,0,.3);}
.modal-title{font-size:19px;font-weight:800;color:#1a3a6b;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #e0e8f0;}
.modal-close{float:right;cursor:pointer;font-size:22px;color:#888;line-height:1;}
.modal-close:hover{color:#c00;}
.seq-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:7px;margin:12px 0;}
.seq-btn{height:48px;font-size:18px;font-weight:800;border:2px solid #b0b8c8;border-radius:8px;cursor:pointer;background:#fff;transition:all .12s;}
.seq-btn:hover{background:#cce0ff;border-color:#1a7fe8;}
.seq-btn.active-sel{background:#1a3a6b;color:#fff;border-color:#1a3a6b;}
.sp-btn{background:#fffbe0;border-color:#e0c800;color:#7a6200;}
.sp-btn:hover{background:#fff7a0;}
.clear-btn{background:#fce4ec;border-color:#f48fb1;color:#880e4f;font-size:14px;}
.note-input{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:14px;margin-top:8px;}
/* â”€â”€ ASSIGN MODAL â”€â”€ */
.assign-item{display:flex;align-items:center;padding:10px 12px;margin:4px 0;border:1px solid #d0d8e4;border-radius:6px;cursor:pointer;transition:all .12s;}
.assign-item:hover{background:#e0f0ff;border-color:#1a7fe8;}
.assign-item .ai-name{font-weight:700;font-size:14px;flex:1;}
.assign-item .ai-info{font-size:14px;color:#666;}
.assign-item .ai-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:6px;}
.assign-item .badge-sp{background:#fffbe0;color:#7a6200;}
.assign-item .badge-regular{background:#e0e8ff;color:#1a3a6b;}
.assign-item .badge-pair{background:#f0e0ff;color:#6a1a8b;}
.assign-empty{text-align:center;padding:20px;color:#888;font-size:14px;}
.modal-ctx{background:#f0f4fa;padding:10px 12px;border-radius:6px;margin-bottom:12px;font-size:15px;color:#334;}
/* â”€â”€ FORM ELEMENTS â”€â”€ */
.form-group{margin-bottom:13px;}
.form-label{display:block;margin-bottom:4px;font-weight:700;color:#334;font-size:15px;}
.form-control{width:100%;padding:8px 11px;border:1px solid #bcc;border-radius:5px;font-size:14px;}
.form-control:focus{border-color:#1a3a6b;outline:none;box-shadow:0 0 0 2px rgba(26,58,107,.2);}
.form-select{width:100%;padding:8px 11px;border:1px solid #bcc;border-radius:5px;font-size:14px;background:#fff;}
/* â”€â”€ EMPLOYEE TABLE â”€â”€ */
.emp-table{border-collapse:collapse;width:100%;font-size:13px;}
.emp-table th{background:#1a3a6b;color:#fff;padding:8px 12px;font-weight:700;}
.emp-table td{border:1px solid #ccc;padding:7px 10px;text-align:center;}
.emp-table tr:hover td{background:#f0f5ff;}
/* â”€â”€ WEEKLY DISPATCH â”€â”€ */
.week-tabs{display:flex;gap:6px;margin-bottom:12px;}
.week-tab{padding:7px 14px;border:2px solid #b0c0d8;border-radius:5px;cursor:pointer;font-weight:600;font-size:13px;background:#fff;color:#445;}
.week-tab.active{background:#1a3a6b;color:#fff;border-color:#1a3a6b;}
.dispatch-table{border-collapse:collapse;font-size:14px;white-space:nowrap;}
.dispatch-table th,.dispatch-table td{border:1px solid #b0b8c8;padding:4px 7px;text-align:center;}
.dh-day{background:#1a3a6b;color:#fff;font-size:14px;font-weight:700;}
.dh-col{background:#2d5a9e;color:#fff;font-size:13px;}
.dam-row{background:#e8f4ff;}
.dpm-row{background:#fff8e8;}
.dw-row{background:#e8ffe8;}
/* â”€â”€ STAT CARDS â”€â”€ */
.stat-cards{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;}
.stat-card{background:#fff;border-radius:8px;padding:12px 18px;box-shadow:0 1px 5px rgba(0,0,0,.1);min-width:110px;}
.sc-label{font-size:13px;color:#667;margin-bottom:2px;}
.sc-value{font-size:24px;font-weight:800;color:#1a3a6b;}
.sc-sub{font-size:13px;color:#888;margin-top:1px;}
/* â”€â”€ SETTINGS â”€â”€ */
.settings-section{background:#fff;border-radius:8px;padding:18px;margin-bottom:16px;box-shadow:0 1px 5px rgba(0,0,0,.08);}
.section-title{font-size:15px;font-weight:700;color:#1a3a6b;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e0e8f0;}
.rotation-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0;}
.rot-cell{display:flex;align-items:center;gap:6px;background:#f0f4fa;padding:7px 10px;border-radius:5px;}
.rot-pos{font-weight:800;color:#1a3a6b;min-width:24px;}
.rot-select{flex:1;padding:4px 6px;border:1px solid #bcc;border-radius:4px;font-size:13px;}
/* â”€â”€ LOADING â”€â”€ */
.loading-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.85);z-index:2000;align-items:center;justify-content:center;flex-direction:column;gap:14px;}
.loading-overlay.show{display:flex;}
.loading-spinner{width:48px;height:48px;border:5px solid #d0d8e8;border-top-color:#1a3a6b;border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:17px;font-weight:700;color:#1a3a6b;}
/* â”€â”€ MISC â”€â”€ */
::-webkit-scrollbar{width:7px;height:7px;}
::-webkit-scrollbar-track{background:#f0f2f5;}
::-webkit-scrollbar-thumb{background:#a0aac0;border-radius:4px;}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:13px;font-weight:700;}
.badge-primary{background:#1a3a6b;color:#fff;}
.badge-success{background:#1e7e34;color:#fff;}
.badge-warning{background:#e07800;color:#fff;}
.badge-danger{background:#c0392b;color:#fff;}
.alert{padding:10px 14px;border-radius:6px;margin-bottom:12px;font-size:13px;}
.alert-info{background:#d0e8ff;border:1px solid #7ab8f5;color:#0a4080;}
.sep{color:#bbb;padding:0 3px;}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
</div>

<!-- HEADER -->
<div class="app-header">
  <div>
    <div class="app-logo">ğŸšŒ M5121</div>
    <div class="app-sub">ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
  </div>
  <div class="month-nav">
    <button onclick="changeMonth(-1)">â—€</button>
    <div class="month-display" id="monthDisplay"></div>
    <button onclick="changeMonth(1)">â–¶</button>
    <button onclick="goToToday()" style="margin-left:6px;font-size:14px;padding:5px 10px;">ì˜¤ëŠ˜</button>
  </div>
</div>

<!-- TABS -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('monthly')" id="tab-monthly">ğŸ“… ì›”ê°„ ê·¼ë¬´í‘œ</button>
  <button class="tab-btn" onclick="switchTab('weekly')" id="tab-weekly">ğŸšŒ ì£¼ê°„ ë°°ì°¨í‘œ</button>
  <button class="tab-btn" onclick="switchTab('employees')" id="tab-employees">ğŸ‘¤ ì§ì› ê´€ë¦¬</button>
  <button class="tab-btn" onclick="switchTab('vehicles')" id="tab-vehicles">ğŸš— ì°¨ëŸ‰ ê´€ë¦¬</button>
  <button class="tab-btn" onclick="switchTab('settings')" id="tab-settings">âš™ï¸ ì„¤ì •</button>
  <button class="tab-btn" onclick="switchTab('guide')" id="tab-guide">ğŸ“– ê·œì¹™/ì§€ì¹¨ì„œ</button>
</div>

<!-- â”€â”€â”€ TAB: ì›”ê°„ ê·¼ë¬´í‘œ â”€â”€â”€ -->
<div class="tab-content active" id="tab-content-monthly">
  <div class="top-bar">
    <span class="top-bar-title" id="monthlyTitle">2026ë…„ 2ì›” ê·¼ë¬´í‘œ</span>
    <button class="btn btn-primary" onclick="autoGenerate()">ğŸ”„ ìë™ ë°°ì¹˜</button>

    <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ì €ì¥</button>
    <button class="btn btn-info" onclick="exportAllImages()">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥</button>
    <button class="btn btn-light" onclick="undoAction()" id="undoBtn" disabled>â†©ï¸ ì‹¤í–‰ì·¨ì†Œ</button>
    <button class="btn btn-light" onclick="clearMonth()" style="margin-left:auto;">ğŸ—‘ï¸ ì´ë²ˆë‹¬ ì´ˆê¸°í™”</button>
  </div>
  <div class="stat-cards" id="statsCards"></div>
  <div class="sched-wrap">
    <div id="scheduleTable"></div>
  </div>
</div>

<!-- â”€â”€â”€ TAB: ì£¼ê°„ ë°°ì°¨í‘œ â”€â”€â”€ -->
<div class="tab-content" id="tab-content-weekly">
  <div class="top-bar">
    <span class="top-bar-title" id="weeklyTitle">ì£¼ê°„ ë°°ì°¨í‘œ</span>
    <button class="btn btn-success" onclick="exportWeeklyExcel()">ğŸ“¥ ì—‘ì…€ ì €ì¥</button>
    <button class="btn btn-info" onclick="exportWeeklyImages()">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥</button>
  </div>
  <div class="week-tabs" id="weekTabs"></div>
  <div id="weeklyDispatchTable"></div>
</div>

<!-- â”€â”€â”€ TAB: ì§ì› ê´€ë¦¬ â”€â”€â”€ -->
<div class="tab-content" id="tab-content-employees">
  <div class="top-bar">
    <span class="top-bar-title">ì§ì› ê´€ë¦¬</span>
    <button class="btn btn-primary" onclick="openAddEmployee()">â• ì§ì› ì¶”ê°€</button>
  </div>
  <div id="employeeTable"></div>
</div>

<!-- â”€â”€â”€ TAB: ì°¨ëŸ‰ ê´€ë¦¬ â”€â”€â”€ -->
<div class="tab-content" id="tab-content-vehicles">
  <div class="top-bar">
    <span class="top-bar-title">ì°¨ëŸ‰ ê´€ë¦¬</span>
  </div>
  <div id="vehicleTable"></div>
</div>

<!-- â”€â”€â”€ TAB: ì„¤ì • â”€â”€â”€ -->
<div class="tab-content" id="tab-content-settings">
  <div class="settings-section">
    <div class="section-title">âš™ï¸ ë¡œí…Œì´ì…˜ ê¸°ì¤€ ì„¤ì •</div>
    <div class="alert alert-info">ğŸ”” <b>ë¡œí…Œì´ì…˜ ê¸°ì¤€ì¼</b>ê³¼ <b>ê·¸ ë‚ ì˜ ì°¨ëŸ‰ ìˆœë²ˆ ë°°ì—´</b>ì„ ì„¤ì •í•˜ë©´ ëª¨ë“  ë‚ ì§œì˜ ìˆœë²ˆì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>ë§¤ì¼ ì°¨ëŸ‰ì´ ì„¸ ì¹¸ì”© <b>ë‚´ë ¤ê°€ëŠ”(ìˆœë²ˆ ì¦ê°€)</b> ë°©ì‹ìœ¼ë¡œ ìˆœí™˜í•©ë‹ˆë‹¤.</div>
    <div class="form-group">
      <label class="form-label">ê¸°ì¤€ì¼ (ì´ ë‚ ì§œì˜ ìˆœë²ˆ ë°°ì—´ì„ ì•„ë˜ì—ì„œ ì„¤ì •)</label>
      <input type="date" class="form-control" id="baseDateInput" style="max-width:200px;">
    </div>
    <div class="section-title" style="margin-top:16px;">ê¸°ì¤€ì¼ ìˆœë²ˆë³„ ì°¨ëŸ‰ ë°°ì •</div>
    <div class="rotation-grid" id="rotationGrid"></div>
    <div style="margin-top:12px;display:flex;gap:10px;">
      <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
      <button class="btn btn-warning" onclick="resetToDefault()">â†©ï¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="settings-section">
    <div class="section-title">ğŸ“ ë°ì´í„° ê´€ë¦¬</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-info" onclick="exportAllData()">ğŸ“¤ ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-warning" onclick="importData()">ğŸ“¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ê·œì¹™/ì§€ì¹¨ì„œ â”€â”€â”€ -->
<div class="tab-content" id="tab-content-guide">
  <div style="max-width:900px;margin:0 auto;">
    <h2 style="color:#1a3a6b;border-bottom:3px solid #1a3a6b;padding-bottom:10px;margin-bottom:20px;">M5121 ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ â€” ê·œì¹™ ë° ì§€ì¹¨ì„œ</h2>

    <div style="background:#e8f4ff;border:1px solid #b0d0f0;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#1a3a6b;margin-bottom:8px;">1. ìš´ì „ì êµ¬ë¶„</h3>
      <table style="width:100%;border-collapse:collapse;font-size:15px;">
        <tr style="background:#1a3a6b;color:#fff;"><th style="padding:8px;border:1px solid #ccc;">êµ¬ë¶„</th><th style="padding:8px;border:1px solid #ccc;">ì„¤ëª…</th><th style="padding:8px;border:1px solid #ccc;">ì°¨ëŸ‰</th></tr>
        <tr><td style="padding:8px;border:1px solid #ddd;font-weight:700;">ê³ ì •ìš´ì „ì</td><td style="padding:8px;border:1px solid #ddd;">ë§¤ì¼ ì •í•´ì§„ ì°¨ëŸ‰ì„ ìš´í–‰í•˜ëŠ” ì •ê·œ ìš´ì „ì (ì˜¤ì „/ì˜¤í›„ êµëŒ€, í˜ì–´ì™€ ê°™ì€ ì°¨ëŸ‰ ê³µìœ )</td><td style="padding:8px;border:1px solid #ddd;">ì°¨ëŸ‰ë²ˆí˜¸ ë°°ì • (ì˜ˆ: 3727) ë˜ëŠ” ì—†ìŒ (í˜ì–´)</td></tr>
        <tr style="background:#f8f8ff;"><td style="padding:8px;border:1px solid #ddd;font-weight:700;">SP (ì˜ˆë¹„)</td><td style="padding:8px;border:1px solid #ddd;">ê³ ì • ìš´ì „ì íœ´ë¬´/ê³µíœ´ì¼/íœ´ë¬´ì „ì¼ì— ëŒ€ì²´ íˆ¬ì…ë˜ëŠ” ì˜ˆë¹„ ìš´ì „ì (ì˜¤ì „/ì˜¤í›„ êµëŒ€, í˜ì–´ì™€ ê°™ì€ ì°¨ëŸ‰ ê³µìœ )</td><td style="padding:8px;border:1px solid #ddd;">SP ë˜ëŠ” ì—†ìŒ (í˜ì–´)</td></tr>
      </table>
    </div>

    <div style="background:#fff8e0;border:1px solid #e0c800;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#7a6200;margin-bottom:8px;">2. ê·¼ë¬´ì¼ìˆ˜ ê³„ì‚° ê·œì¹™ (ë§Œê·¼ìˆ˜)</h3>
      <p style="margin-bottom:8px;">ë§Œê·¼ìˆ˜ = <b>í•´ë‹¹ì›” ì´ ì¼ìˆ˜</b> - <b>íœ´ë¬´ì¼ ìˆ˜</b> - <b>íœ´ë¬´ì „ì¼ ìˆ˜</b> - <b>ë²•ì •ê³µíœ´ì¼ ìˆ˜</b></p>
      <ul style="margin-left:20px;line-height:2;">
        <li><b>íœ´ë¬´ì¼</b>: ê° ìš´ì „ìì—ê²Œ ì§€ì •ëœ ìš”ì¼ (ì˜ˆ: ì›”ìš”ì¼ íœ´ë¬´ìëŠ” ë§¤ì£¼ ì›”ìš”ì¼ ì‰¼)</li>
        <li><b>íœ´ë¬´ìš”ì¼(-1)</b>: íœ´ë¬´ì¼ ì „ë‚ ì˜ ìš”ì¼ (ì˜ˆ: ì›”ìš”ì¼ íœ´ë¬´ìì˜ íœ´ë¬´ì „ì¼ = ì¼ìš”ì¼). ì§ì›ê´€ë¦¬ì—ì„œ ìˆ˜ì • ê°€ëŠ¥</li>
        <li><b>ë²•ì •ê³µíœ´ì¼</b>: ì‹ ì •, ì‚¼ì¼ì ˆ, ì–´ë¦°ì´ë‚ , í˜„ì¶©ì¼, ê´‘ë³µì ˆ, ê°œì²œì ˆ, í•œê¸€ë‚ , ì„±íƒ„ì ˆ + ì„¤/ì¶”ì„ ì—°íœ´</li>
        <li><b>ëŒ€ì²´ê³µíœ´ì¼</b>: ë²•ì •ê³µíœ´ì¼ì´ ì£¼ë§ê³¼ ê²¹ì¹  ë•Œ ì§€ì •ë˜ëŠ” ëŒ€ì²´ íœ´ì¼ (ì˜ˆ: ì‚¼ì¼ì ˆì´ ì¼ìš”ì¼ì´ë©´ ì›”ìš”ì¼ ëŒ€ì²´ê³µíœ´ì¼)</li>
        <li style="color:#c70000;"><b>ê²¹ì¹¨ ì œì™¸</b>: íœ´ë¬´ì¼Â·íœ´ë¬´ì „ì¼Â·ê³µíœ´ì¼ì´ ê²¹ì¹˜ëŠ” ê²½ìš° ì¤‘ë³µìœ¼ë¡œ ë¹¼ì§€ ì•ŠìŒ (1ë²ˆë§Œ ì°¨ê°)</li>
      </ul>
      <div style="background:#fff;border:1px solid #ddd;border-radius:4px;padding:10px;margin-top:10px;">
        <b>ì˜ˆì‹œ)</b> 3ì›”(31ì¼), ì›”ìš”ì¼ íœ´ë¬´ì: 31 - 5(ì›”) - 5(ì¼) - 0(ê³µíœ´ì¼ ê²¹ì¹¨ìœ¼ë¡œ ì¶”ê°€ì°¨ê° ì—†ìŒ) = <b>21ì¼</b><br>
        <b>ì˜ˆì‹œ)</b> 3ì›”(31ì¼), ëª©ìš”ì¼ íœ´ë¬´ì: 31 - 4(ëª©) - 4(ìˆ˜) - 2(3/1ì‚¼ì¼ì ˆ, 3/2ëŒ€ì²´ê³µíœ´ì¼) = <b>21ì¼</b>
      </div>
    </div>

    <div style="background:#e8ffe8;border:1px solid #78c48a;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#155724;margin-bottom:8px;">3. ìë™ë°°ì¹˜ ê·œì¹™ (ë°°ì¹˜ ìˆœì„œ)</h3>
      <table style="width:100%;border-collapse:collapse;font-size:15px;">
        <tr style="background:#1e7e34;color:#fff;"><th style="padding:8px;border:1px solid #ccc;">ë‹¨ê³„</th><th style="padding:8px;border:1px solid #ccc;">ë‚´ìš©</th><th style="padding:8px;border:1px solid #ccc;">í•µì‹¬ ê·œì¹™</th></tr>
        <tr><td style="padding:8px;border:1px solid #ddd;font-weight:700;width:80px;">0ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">í¸ë„(ìˆ˜) ì„ ë°°ì¹˜</td><td style="padding:8px;border:1px solid #ddd;">í‰ì¼(ì›”~ê¸ˆ) ë§¤ì¼ <b>ë°˜ë“œì‹œ 2ëª…</b> ë°°ì •, <b>1ì¸ë‹¹ ì›” ìµœëŒ€ 3íšŒ</b><br>í›„ë³´: <b>ê³ ì •ìš´ì „ì + SP í¬í•¨ ì „ì²´ ìš´ì „ì</b> â€” íœ´ë¬´ ìš”ì¼ ë¬´ê´€<br><b>1ì°¨ ì •ë ¬: ìˆ˜í•©íšŸìˆ˜ ì ì€ ìˆœ (ê· ë“± ë¶„ë°°)</b>, 2ì°¨: ì‰¬ëŠ”ë‚  ìš°ì„  (íœ´ë¬´ì¼ &gt; íœ´ë¬´ì „ì¼ &gt; ê³µíœ´ì¼)</td></tr>
        <tr style="background:#f0fff0;"><td style="padding:8px;border:1px solid #ddd;font-weight:700;">1ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">ê³ ì •ìš´ì „ì ë°°ì¹˜</td><td style="padding:8px;border:1px solid #ddd;">ë§Œê·¼ìˆ˜ - ìˆ˜í•©íšŸìˆ˜ = ì •ê·œê·¼ë¬´ ìƒí•œ<br><b>1ì°¨</b>: íœ´ë¬´ì¼Â·íœ´ë¬´ì „ì¼Â·ê³µíœ´ì¼ ì œì™¸í•˜ê³  ë°°ì¹˜<br><b>2ì°¨</b>: ë¶€ì¡± ì‹œ <b>íœ´ë¬´ì „ì¼/ê³µíœ´ì¼</b>ì— ì¶”ê°€ ë°°ì¹˜ (ë§Œê·¼ ë³´ì¥)<br>í†  10ëŒ€, ì¼/ê³µíœ´ì¼ 8ëŒ€ ìˆœë²ˆ ì œí•œ, ì£¼ 5~6ì¼ êµì°¨ ì œí•œ</td></tr>
        <tr><td style="padding:8px;border:1px solid #ddd;font-weight:700;">2ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">SP ëŒ€ì²´ ë°°ì¹˜</td><td style="padding:8px;border:1px solid #ddd;">ê³ ì •ìš´ì „ì ê³µì„(íœ´ë¬´/íœ´ë¬´ì „ì¼/ê³µíœ´ì¼/ìˆ˜í•©ì¼) ìˆœë²ˆì— SP íˆ¬ì…<br>SP ë§Œê·¼+2 ì´ë‚´, ì£¼ 5~6ì¼ êµì°¨ ì œí•œ<br><b>ë§Œê·¼ ëŒ€ë¹„ ë¶€ì¡±ìœ¨ ë†’ì€ SP ìš°ì„ </b> (ê· ë“± ë°°ë¶„)</td></tr>
        <tr style="background:#f0fff0;"><td style="padding:8px;border:1px solid #ddd;font-weight:700;">3ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">ì”ì—¬ ì´ˆê³¼ í•´ì†Œ</td><td style="padding:8px;border:1px solid #ddd;">ê³ ì •ê·¼ë¬´ìì— ì´ˆê³¼ê°€ ë‚¨ì•„ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ë°°ì •ì¼ë¶€í„° ì œê±°<br>ë¹ˆ ìˆœë²ˆì€ SPê°€ ëŒ€ì²´ íˆ¬ì… (ë¶€ì¡±ìœ¨ ë†’ì€ SP ìš°ì„ )</td></tr>
        <tr><td style="padding:8px;border:1px solid #ddd;font-weight:700;">4ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">SP ë°¸ëŸ°ìŠ¤</td><td style="padding:8px;border:1px solid #ddd;">ì´ˆê³¼(over&gt;0)ì¸ SPì—ì„œ ë¶€ì¡±(over&lt;0)ì¸ SPë¡œ ê·¼ë¬´ ì´ë™<br>ëª¨ë“  SPê°€ ìµœì†Œ ë§Œê·¼ ë‹¬ì„±í•˜ë„ë¡ ì¬ë°°ë¶„</td></tr>
        <tr style="background:#f0fff0;"><td style="padding:8px;border:1px solid #ddd;font-weight:700;">5ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">ì£¼ë§/ê³µíœ´ì¼ ì •ì› ë³´ì¥</td><td style="padding:8px;border:1px solid #ddd;">í†  10ëŒ€, ì¼/ê³µíœ´ì¼ 8ëŒ€ ì •ì›ì„ ê°•ì œ ë³´ì¥<br>ë¹ˆ ìˆœë²ˆì— SP ìš°ì„ , ë¶€ì¡± ì‹œ ê³ ì •ìš´ì „ì ì¶”ê°€ íˆ¬ì…</td></tr>
        <tr><td style="padding:8px;border:1px solid #ddd;font-weight:700;">6ë‹¨ê³„</td><td style="padding:8px;border:1px solid #ddd;">í‰ì¼ ì •ì› ë³´ì¥</td><td style="padding:8px;border:1px solid #ddd;">í‰ì¼ ì˜¤ì „ 16ëŒ€, ì˜¤í›„ 16ëŒ€ ì •ì›ì„ ê°•ì œ ë³´ì¥<br>ë¹ˆ ìˆœë²ˆì— ê°€ìš© ìš´ì „ìë¥¼ íˆ¬ì…í•˜ì—¬ ì™„ì„±</td></tr>
      </table>
    </div>

    <div style="background:#fff0f0;border:1px solid #f5c2c7;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#842029;margin-bottom:8px;">4. ê·¼ë¬´ ì œí•œ ê·œì¹™</h3>
      <ul style="margin-left:20px;line-height:2.2;">
        <li><b>ì£¼ 5~6ì¼ êµì°¨ ì œí•œ</b>: í•œ ì£¼ì— 6ì¼ ê·¼ë¬´ ì‹œ ë‹¤ìŒ ì£¼ëŠ” ìµœëŒ€ 5ì¼, 5ì¼ ì´í•˜ ê·¼ë¬´ ì‹œ ë‹¤ìŒ ì£¼ ìµœëŒ€ 6ì¼</li>
        <li><b>ê³ ì •ìš´ì „ì ì´ˆê³¼ = 0</b>: ê³ ì •ìš´ì „ìëŠ” ë§Œê·¼ìˆ˜ë¥¼ ì •í™•íˆ ë‹¬ì„± (ë¶€ì¡± ì‹œ íœ´ë¬´ì „ì¼/ê³µíœ´ì¼ì— ì¶”ê°€ ë°°ì¹˜)</li>
        <li><b>SP ë§Œê·¼+2</b>: SP ìš´ì „ìëŠ” ë§Œê·¼ìˆ˜ + 2ì¼ê¹Œì§€ ê·¼ë¬´ ê°€ëŠ¥ (ì´ˆê³¼ê·¼ë¬´ í—ˆìš©)<br>
          <b>SP ë°¸ëŸ°ìŠ¤</b>: ì´ˆê³¼ SPì™€ ë¶€ì¡± SP ê°„ ê·¼ë¬´ë¥¼ ì´ë™í•˜ì—¬ ê· ë“± ë¶„ë°°</li>
        <li><b>í¸ë„(ìˆ˜) ì›” 3íšŒ</b>: <b>ê³ ì •ìš´ì „ì + SP í¬í•¨</b> ì „ì› 1ì¸ë‹¹ ì›” ìµœëŒ€ 3íšŒ, ìë™ë°°ì¹˜ ë° ìˆ˜ë™ ë°°ì¹˜ ì‹œ 3íšŒ ì´ˆê³¼ ë°©ì§€</li>
        <li><b>ì‹œê°„ëŒ€ë³„ ëŒ€ì²´ ê·œì¹™</b>: AMê³µì„ â†’ AM ìš´ì „ìë§Œ ëŒ€ì²´ ê°€ëŠ¥ / PMê³µì„ â†’ AM+PM ëª¨ë‘ ëŒ€ì²´ ê°€ëŠ¥</li>
        <li><b>ëŒ€ì²´ ê°€ëŠ¥ ì¡°ê±´</b>: ì´ê·¼ë¬´ &lt; ë§Œê·¼+2 ì´ë‚´ì¸ ìš´ì „ìë§Œ ê·¼ë¬´ê°€ëŠ¥(ì´ˆë¡) í‘œì‹œ</li>
      </ul>
    </div>

    <div style="background:#f0f0ff;border:1px solid #b0b0e0;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#333399;margin-bottom:8px;">5. ì°¨ëŸ‰ ë¡œí…Œì´ì…˜ ê·œì¹™</h3>
      <ul style="margin-left:20px;line-height:2.2;">
        <li><b>16ëŒ€ ë¡œí…Œì´ì…˜</b>: ì°¨ëŸ‰ 16ëŒ€ê°€ ë§¤ì¼ ìˆœë²ˆì´ 3ì¹¸ì”© ìˆœí™˜ (ìˆœë²ˆ ì¦ê°€ ë°©í–¥)</li>
        <li><b>í‰ì¼</b>: 16ëŒ€ ì „ë¶€ ìš´í–‰ (ìˆœë²ˆ 1~16)</li>
        <li><b>í† ìš”ì¼</b>: 10ëŒ€ ìš´í–‰ (ìˆœë²ˆ 1~10, ë‚˜ë¨¸ì§€ ë¯¸ìš´í–‰)</li>
        <li><b>ì¼ìš”ì¼</b>: 8ëŒ€ ìš´í–‰ (ìˆœë²ˆ 1~8, ë‚˜ë¨¸ì§€ ë¯¸ìš´í–‰)</li>
        <li><b>ê¸°ì¤€ì¼ ì„¤ì •</b>: ì„¤ì • íƒ­ì—ì„œ ê¸°ì¤€ì¼ê³¼ í•´ë‹¹ì¼ì˜ ì°¨ëŸ‰ ìˆœë²ˆ ë°°ì—´ì„ ì§€ì •í•˜ë©´ ì „ì²´ ë‹¬ë ¥ì´ ìë™ ê³„ì‚°</li>
      </ul>
    </div>

    <div style="background:#f5f0ff;border:1px solid #c0b0e0;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#6a1a8b;margin-bottom:8px;">6. í¸ë„(ìˆ˜í•©) ìš´í–‰ ê·œì¹™</h3>
      <ul style="margin-left:20px;line-height:2.2;">
        <li><b>ìš´í–‰ì¼</b>: ì›”~ê¸ˆ í‰ì¼ ë§¤ì¼ <b>ë°˜ë“œì‹œ 2ëª…</b> (í† /ì¼ ì œì™¸)</li>
        <li><b>ì°¨ëŸ‰</b>: 6005í˜¸, 3511í˜¸ (2ëŒ€)</li>
        <li><b>ì›” ì œí•œ</b>: <b>1ì¸ë‹¹ ì›” ìµœëŒ€ 3íšŒ</b></li>
        <li><b>ë°°ì • ëŒ€ìƒ</b>: <b>ê³ ì •ìš´ì „ì + SP í¬í•¨ ì „ì²´ ìš´ì „ì</b> â€” íœ´ë¬´ ìš”ì¼ê³¼ ë¬´ê´€í•˜ê²Œ ì „ì› ì°¸ì—¬<br>
          <b>1ì°¨ ì •ë ¬: ìˆ˜í•©íšŸìˆ˜ ì ì€ ìˆœ (ê· ë“± ë¶„ë°°)</b>, 2ì°¨: ì‰¬ëŠ”ë‚  ìš°ì„  (íœ´ë¬´ì¼ &gt; íœ´ë¬´ì „ì¼ &gt; ê³µíœ´ì¼)</li>
        <li><b>ìš´í–‰ ì‹œê°</b>: 6005í˜¸(05:20/07:46), 3511í˜¸(05:40/08:05) â€” ì˜¤ì „ë§Œ ìš´í–‰</li>
      </ul>
    </div>

    <div style="background:#e0f0ff;border:1px solid #a0c8e8;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#0d6efd;margin-bottom:8px;">7. ì›”ê°„ ê·¼ë¬´í‘œ ë³´ëŠ” ë²•</h3>
      <ul style="margin-left:20px;line-height:2.2;">
        <li><b>ìˆ«ì (1~6)</b>: í•´ë‹¹ ì£¼ ë‚´ ëª‡ ë²ˆì§¸ ê·¼ë¬´ì¼ì¸ì§€ í‘œì‹œ (ì˜ˆ: 3 = ì´ë²ˆ ì£¼ 3ì¼ì§¸)</li>
        <li><b>"ìˆ˜"</b>: í¸ë„(ìˆ˜í•©) ë°°ì •ì¼ â€” ì´ˆë¡ìƒ‰ ë°°ê²½</li>
        <li><b>ë¹ˆ ì¹¸</b>: ë¯¸ë°°ì • (íœ´ë¬´ì¼/íœ´ë¬´ì „ì¼/ê³µíœ´ì¼/ìš´í–‰ ìˆœë²ˆ ì´ˆê³¼)</li>
        <li style="color:#dc3545;"><b>ë¹¨ê°„ ë°°ê²½</b>: ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•œ ê³µì„ â€” í´ë¦­í•˜ë©´ ëŒ€ì²´ ê°€ëŠ¥ ìš´ì „ì ëª©ë¡ í‘œì‹œ</li>
        <li style="color:#28a745;"><b>ì´ˆë¡ ë°°ê²½</b>: í•´ë‹¹ ë‚  ê³µì„ì„ ëŒ€ì²´í•  ìˆ˜ ìˆëŠ” ìš´ì „ì â€” í´ë¦­í•˜ë©´ ë°°ì¹˜í•  ê³µì„ ëª©ë¡ í‘œì‹œ</li>
        <li style="color:#7a6000;"><b>ë…¸ë€ ë°°ê²½</b>: ê°œì¸ íœ´ë¬´ì¼ ë˜ëŠ” íœ´ë¬´ì „ì¼ â€” ì˜¤ì „/ì˜¤í›„ ë¬´ê´€, ê°’ì´ ìˆì–´ë„ ë…¸ë€ìƒ‰ í‘œì‹œ</li>
        <li><b>ì—°ë…¸ë€ ë°‘ì¤„</b>: ë©”ëª¨ê°€ ìˆëŠ” ì…€</li>
        <li><b>ì£¼í™© ë°°ê²½</b>: ë²•ì •ê³µíœ´ì¼ / ê³µíœ´ì¼ ì „ë‚ </li>
      </ul>
    </div>

    <div style="background:#fff8e8;border:1px solid #e0c080;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#b05000;margin-bottom:8px;">8. ìˆ˜ë™ ë°°ì¹˜/ìˆ˜ì • ë°©ë²•</h3>
      <ul style="margin-left:20px;line-height:2.2;">
        <li><b>ì¼ë°˜ ì…€ í´ë¦­</b>: 1~6 ì£¼ê°„ ê·¼ë¬´ì¼ìˆ˜ ë²„íŠ¼ìœ¼ë¡œ ê°’ ì„¤ì •, ë©”ëª¨ ì…ë ¥ ê°€ëŠ¥</li>
        <li><b>ë¹¨ê°„ ì…€(ê³µì„) í´ë¦­</b>: í•´ë‹¹ ê³µì„ì„ ì±„ìš¸ ìˆ˜ ìˆëŠ” ìš´ì „ì ëª©ë¡ì´ ë‚˜íƒ€ë‚¨ â†’ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ë°°ì¹˜</li>
        <li><b>ì´ˆë¡ ì…€(ëŒ€ì²´ê°€ëŠ¥) í´ë¦­</b>: ì´ ìš´ì „ìë¥¼ ë°°ì¹˜í•  ìˆ˜ ìˆëŠ” ê³µì„ ëª©ë¡ì´ ë‚˜íƒ€ë‚¨ â†’ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ë°°ì¹˜<br>
          ìˆ˜í•©(ìˆ˜) ê³µì„: ìˆœë²ˆì´ ì•„ë‹Œ 'ìˆ˜'ë¡œ ë°°ì¹˜ë¨, í¸ë„(ìˆ˜) í•©ê³„ì— ë°˜ì˜ë¨</li>
        <li><b>ë“œë˜ê·¸ ì„ íƒ</b>: ì—¬ëŸ¬ ë‚ ì„ ë“œë˜ê·¸í•˜ì—¬ í•œë²ˆì— ì‚­ì œ ê°€ëŠ¥</li>
        <li><b>ì‹¤í–‰ ì·¨ì†Œ</b>: Ctrl+Z ë˜ëŠ” í•˜ë‹¨ "ì‹¤í–‰ ì·¨ì†Œ" ë²„íŠ¼ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</li>
      </ul>
    </div>


    <div style="background:#e8f8e8;border:1px solid #a0d0a0;border-radius:8px;padding:16px;margin-bottom:20px;">
      <h3 style="color:#155724;margin-bottom:8px;">9. ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥</h3>
      <ul style="margin-left:20px;line-height:2.2;">
        <li><b>ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</b>: ì›”ê°„ ê·¼ë¬´í‘œë¥¼ .xlsx íŒŒì¼ë¡œ ì €ì¥</li>
        <li><b>ì£¼ë°°ì°¨ ì—‘ì…€</b>: ì£¼ê°„ ë°°ì°¨í‘œë¥¼ ì£¼ì°¨ë³„ ì‹œíŠ¸ë¡œ ì €ì¥</li>
        <li><b>ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°</b>: íŠ¹ì • ì¼ì ë°°ì°¨í‘œë¥¼ PNG ì´ë¯¸ì§€ë¡œ ì €ì¥</li>
        <li><b>ì „ì²´ ì´ë¯¸ì§€ ZIP</b>: í•´ë‹¹ ì›” ëª¨ë“  ì¼ì ë°°ì°¨í‘œë¥¼ ZIPìœ¼ë¡œ ì €ì¥</li>
        <li><b>ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°</b>: JSON í˜•ì‹ìœ¼ë¡œ ì „ì²´ ë°ì´í„° ë°±ì—…/ë³µì›</li>
      </ul>
    </div>

  </div>
</div>

<!-- â”€â”€â”€ FOOTER â”€â”€â”€ -->
<div class="app-footer">
  <button class="btn btn-primary" onclick="saveAll()">ğŸ’¾ ì €ì¥</button>
  <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
  <button class="btn btn-info" onclick="exportCurrentDayImage()">ğŸ“¸ ì˜¤ëŠ˜ ë°°ì°¨ ì´ë¯¸ì§€</button>
  <button class="btn btn-light" onclick="undoAction()" id="undoBtn2" disabled>â†©ï¸ ì‹¤í–‰ì·¨ì†Œ</button>
  <span style="margin-left:auto;font-size:14px;color:#666;" id="saveStatus">ìë™ ì €ì¥ ì™„ë£Œ</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CELL EDIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="cellModal">
  <div class="modal-box">
    <span class="modal-close" onclick="closeModal('cellModal')">âœ•</span>
    <div class="modal-title" id="cellModalTitle">ìˆœë²ˆ ì…ë ¥</div>
    <div class="modal-ctx" id="cellModalCtx"></div>
    <div style="font-weight:700;margin-bottom:6px;font-size:13px;">ìˆœë²ˆ ì„ íƒ (ì´ë²ˆ ì£¼ í‘œì‹œ: 1~6)</div>
    <div class="seq-grid" id="seqGrid"></div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="seq-btn sp-btn" style="width:auto;padding:10px 16px;height:auto;font-size:14px;" onclick="setCell('ìˆ˜',event)">ìˆ˜ (ìˆ˜ìš”ìš´í–‰)</button>
      <button class="seq-btn clear-btn" style="width:auto;padding:10px 16px;height:auto;font-size:14px;" onclick="setCell(null,event)">ì‚­ì œ (ê³µë€)</button>
    </div>
    <div style="margin-top:12px;">
      <label class="form-label">íŠ¹ì´ì‚¬í•­ ë©”ëª¨</label>
      <input type="text" class="note-input" id="cellNoteInput" placeholder="ë³‘ê°€, ê²°ê·¼, êµì²´ ë“± ë©”ëª¨">
    </div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModal('cellModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCell()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMPLOYEE EDIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="empModal">
  <div class="modal-box">
    <span class="modal-close" onclick="closeModal('empModal')">âœ•</span>
    <div class="modal-title" id="empModalTitle">ì§ì› ì¶”ê°€/ìˆ˜ì •</div>
    <input type="hidden" id="empId">
    <div style="display:grid;grid-template-columns:1fr 2fr;gap:12px;">
      <div class="form-group">
        <label class="form-label">í‘œì‹œ ë²ˆí˜¸</label>
        <input type="number" class="form-control" id="empSeq" min="1" placeholder="ë²ˆí˜¸">
      </div>
      <div class="form-group">
        <label class="form-label">ì„±ëª… *</label>
        <input type="text" class="form-control" id="empName" placeholder="ì´ë¦„ ì…ë ¥">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="form-group">
        <label class="form-label">ë°°ì • ì°¨ëŸ‰ë²ˆí˜¸</label>
        <input type="text" class="form-control" id="empVehicle" placeholder="ì˜ˆ: 3727, SP, ì—†ìŒ">
      </div>
      <div class="form-group">
        <label class="form-label">íœ´ë¬´ìš”ì¼ *</label>
        <select class="form-select" id="empDayOff" onchange="autoFillPreDayOff()">
          <option>ì›”</option><option>í™”</option><option>ìˆ˜</option>
          <option>ëª©</option><option>ê¸ˆ</option><option>í† </option><option>ì¼</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">íœ´ë¬´ìš”ì¼(-1) *</label>
        <select class="form-select" id="empPreDayOff">
          <option>ì›”</option><option>í™”</option><option>ìˆ˜</option>
          <option>ëª©</option><option>ê¸ˆ</option><option>í† </option><option>ì¼</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">íŠ¹ì´ì‚¬í•­</label>
      <input type="text" class="form-control" id="empNote" placeholder="ì˜ˆ: ì˜¤í›„ì¡° 5ê°œë§Œ, ë³‘ê°€ ë“±">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button class="btn btn-secondary" onclick="closeModal('empModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveEmployee()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RANGE ACTION MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="rangeModal">
  <div class="modal-box">
    <span class="modal-close" onclick="closeModal('rangeModal')">âœ•</span>
    <div class="modal-title">ë²”ìœ„ ì¼ê´„ ì²˜ë¦¬</div>
    <div class="modal-ctx" id="rangeCtx"></div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
      <button class="btn btn-danger" onclick="rangeAction('ê²°ê·¼')">ğŸ”´ ê²°ê·¼ ì²˜ë¦¬ (ê³µë€ + ë©”ëª¨)</button>
      <button class="btn btn-warning" onclick="rangeAction('ë³‘ê°€')">ğŸŸ¡ ë³‘ê°€ ì²˜ë¦¬ (ê³µë€ + ë©”ëª¨)</button>
      <button class="btn btn-secondary" onclick="rangeAction('clear')">â¬œ ê³µë€ ì´ˆê¸°í™”</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIRM MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="confirmModal">
  <div class="modal-box" style="max-width:380px;">
    <div class="modal-title" id="confirmTitle">í™•ì¸</div>
    <div id="confirmMsg" style="margin-bottom:18px;font-size:14px;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="confirmOkBtn">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ë°°ì¹˜ ëª¨ë‹¬ (ë¹¨ê°„/ì´ˆë¡ ì…€ í´ë¦­ ì‹œ) -->
<div class="modal-bg" id="assignModal">
  <div class="modal-box">
    <span class="modal-close" onclick="closeModal('assignModal')">&times;</span>
    <div class="modal-title" id="assignModalTitle"></div>
    <div class="modal-ctx" id="assignModalCtx"></div>
    <div id="assignModalList" style="max-height:50vh;overflow-y:auto;"></div>
  </div>
</div>

<!-- ì°¨ëŸ‰ ìš´ì „ì ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal-bg" id="vehModal">
  <div class="modal-box" style="max-width:450px;">
    <span class="modal-close" onclick="closeModal('vehModal')">&times;</span>
    <div class="modal-title" id="vehEditTitle">ì°¨ëŸ‰ ìš´ì „ì ìˆ˜ì •</div>
    <input type="hidden" id="vehEditIdx">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group">
        <label class="form-label">ì˜¤ì „ ìš´ì „ì (ì£¼)</label>
        <select class="form-select" id="vehEditMain"></select>
      </div>
      <div class="form-group">
        <label class="form-label">ì˜¤í›„ ìš´ì „ì (ë¶€)</label>
        <select class="form-select" id="vehEditPair"></select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button class="btn btn-secondary" onclick="closeModal('vehModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveVehicleEdit()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyCueopvklcG4MIiaKcFtMwcoo0pCvjHudk",
  authDomain: "m5121-55603.firebaseapp.com",
  databaseURL: "https://m5121-55603-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "m5121-55603",
  storageBucket: "m5121-55603.firebasestorage.app",
  messagingSenderId: "641365889110",
  appId: "1:641365889110:web:ba1ea370d0c4531ddf6bf7"
};
firebase.initializeApp(firebaseConfig);
const fbDb = firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°ì´í„° ìƒìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_DRIVERS = [
  {id:1,  name:'í•œë¯¼ìˆ˜', vehicle:'3727', dayOff:'ì›”', preDayOff:'ì¼', shift:'ì˜¤ì „', note:'', active:true},
  {id:2,  name:'ê¹€ìš©ì¤€', vehicle:'',     dayOff:'ì›”', preDayOff:'ì¼', shift:'ì˜¤í›„', note:'', active:true},
  {id:3,  name:'ë°•ì‚°ìš°', vehicle:'3529', dayOff:'ì›”', preDayOff:'ì¼', shift:'ì˜¤ì „', note:'', active:true},
  {id:4,  name:'ì´ì¶©í˜¸', vehicle:'',     dayOff:'ì›”', preDayOff:'ì¼', shift:'ì˜¤í›„', note:'', active:true},
  {id:5,  name:'ê¹€í˜•ìˆ˜', vehicle:'3528', dayOff:'í™”', preDayOff:'ì›”', shift:'ì˜¤ì „', note:'', active:true},
  {id:6,  name:'ê¹€ì •êµ¬', vehicle:'',     dayOff:'í™”', preDayOff:'ì›”', shift:'ì˜¤í›„', note:'', active:true},
  {id:7,  name:'ë°•ì˜ë¯¼', vehicle:'3351', dayOff:'ìˆ˜', preDayOff:'í™”', shift:'ì˜¤ì „', note:'', active:true},
  {id:8,  name:'ê¹€ìš©ì„', vehicle:'',     dayOff:'ìˆ˜', preDayOff:'í™”', shift:'ì˜¤í›„', note:'', active:true},
  {id:9,  name:'ê¹€ìƒìˆ˜', vehicle:'3523', dayOff:'ëª©', preDayOff:'ìˆ˜', shift:'ì˜¤ì „', note:'', active:true},
  {id:10, name:'ìœ ë³‘í˜¸', vehicle:'',     dayOff:'ëª©', preDayOff:'ìˆ˜', shift:'ì˜¤í›„', note:'', active:true},
  {id:11, name:'ë°•ì‹œì›', vehicle:'3710', dayOff:'ê¸ˆ', preDayOff:'ëª©', shift:'ì˜¤ì „', note:'', active:true},
  {id:12, name:'ê°•í˜„ì„', vehicle:'',     dayOff:'ê¸ˆ', preDayOff:'ëª©', shift:'ì˜¤í›„', note:'', active:true},
  {id:13, name:'ì²œì„±ì›', vehicle:'3726', dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤ì „', note:'', active:true},
  {id:14, name:'ìœ¤í˜•ì£¼', vehicle:'',     dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤í›„', note:'', active:true},
  {id:15, name:'ì‹ ë™ì„±', vehicle:'3700', dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤ì „', note:'', active:true},
  {id:16, name:'ë°•ì€ì¤€', vehicle:'',     dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤í›„', note:'', active:true},
  {id:17, name:'í—ˆìƒêµ¬', vehicle:'3709', dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤ì „', note:'', active:true},
  {id:18, name:'ì´ìš©í˜„', vehicle:'',     dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤í›„', note:'', active:true},
  {id:19, name:'ê¹€ëª…ì„', vehicle:'3713', dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤ì „', note:'', active:true},
  {id:20, name:'ì´í¬ì² ', vehicle:'',     dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤í›„', note:'', active:true},
  {id:21, name:'ë°°ì¬ìš©', vehicle:'3350', dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:22, name:'ì¡°ì°¬í¬', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:23, name:'ì´ê°•ë…•', vehicle:'3521', dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:24, name:'ì´ê±´í¬', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:25, name:'í•œì¸ê·œ', vehicle:'3524', dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:26, name:'ê¹€ìš°í˜„', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:27, name:'ë°•ìš©ìš°', vehicle:'3341', dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:28, name:'ì´ì„±í˜•', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:29, name:'ì¡°ìœ¤ì¬', vehicle:'3729', dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:30, name:'ìµœê²½ë‚¨', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:31, name:'ì •ì„¸í›ˆ', vehicle:'3711', dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:32, name:'ì§€ì„±í›ˆ', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:33, name:'ì´ì •ì™„', vehicle:'SP',   dayOff:'ìˆ˜', preDayOff:'í™”', shift:'ì˜¤ì „', note:'', active:true},
  {id:34, name:'ê¹€ì„ ë¬¸', vehicle:'',     dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤í›„', note:'', active:true},
  {id:35, name:'ì„œì„ ì›', vehicle:'SP',   dayOff:'í† ', preDayOff:'ê¸ˆ', shift:'ì˜¤ì „', note:'', active:true},
  {id:36, name:'ìµœí™œìˆ˜', vehicle:'',     dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤í›„', note:'', active:true},
  {id:37, name:'ì¡°ì„±ê¸°', vehicle:'SP',   dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
  {id:38, name:'ì¡°ìœ ë¯¸', vehicle:'',     dayOff:'ëª©', preDayOff:'ìˆ˜', shift:'ì˜¤í›„', note:'', active:true},
  {id:39, name:'ë¬¸ë•ì›', vehicle:'SP',   dayOff:'ì¼', preDayOff:'í† ', shift:'ì˜¤ì „', note:'', active:true},
];

// ê¸°ë³¸ ì°¨ëŸ‰ ìˆœì„œ (16ëŒ€, ìœ„ì¹˜1=ì¸ë±ìŠ¤0)
const DEFAULT_BASE_VEHICLES = ['3341','3350','3351','3521','3523','3524','3528','3529','3700','3709','3710','3711','3713','3726','3727','3729'];

// í‰ì¼ ì˜¤ì „ í¸ë„(ìˆ˜) ì°¨ëŸ‰ â€” ì›”~ê¸ˆ ë§¤ì¼ ìš´í–‰, íœ´ì¼ê·¼ë¬´ì ìš´ìš©
const WED_VEHICLES = [{num:'6005',am1:'05:20',am2:'07:46'},{num:'3511',am1:'05:40',am2:'08:05'}];

// ìš´í–‰ ì‹œê°í‘œ (ìˆœë²ˆ 1~16)
const SCHEDULE_TIMES = [
  {seq:1, am1:'05:10',am2:'07:55',pm1:'11:50',pm2:'16:25',pm3:'20:33'},
  {seq:2, am1:'05:30',am2:'08:20',pm1:'12:10',pm2:'16:34',pm3:'20:45'},
  {seq:3, am1:'05:50',am2:'08:40',pm1:'12:30',pm2:'16:43',pm3:'21:00'},
  {seq:4, am1:'06:00',am2:'09:00',pm1:'12:45',pm2:'16:52',pm3:'21:12'},
  {seq:5, am1:'06:10',am2:'09:20',pm1:'13:00',pm2:'17:01',pm3:'21:24'},
  {seq:6, am1:'06:20',am2:'09:36',pm1:'13:15',pm2:'17:11',pm3:'21:36'},
  {seq:7, am1:'06:30',am2:'09:48',pm1:'13:30',pm2:'17:22',pm3:'21:48'},
  {seq:8, am1:'06:38',am2:'10:00',pm1:'13:45',pm2:'17:34',pm3:'22:00'},
  {seq:9, am1:'06:46',am2:'10:12',pm1:'14:00',pm2:'17:46',pm3:'22:12'},
  {seq:10,am1:'06:54',am2:'10:24',pm1:'14:15',pm2:'17:59',pm3:'22:25'},
  {seq:11,am1:'07:01',am2:'10:36',pm1:'14:30',pm2:'18:20',pm3:'22:40'},
  {seq:12,am1:'07:08',am2:'10:48',pm1:'14:45',pm2:'18:40',pm3:null},
  {seq:13,am1:'07:15',am2:'11:00',pm1:'15:00',pm2:'18:55',pm3:null},
  {seq:14,am1:'07:22',am2:'11:12',pm1:'15:30',pm2:'19:25',pm3:null},
  {seq:15,am1:'07:30',am2:'11:24',pm1:'16:00',pm2:'19:55',pm3:null},
  {seq:16,am1:'07:38',am2:'11:36',pm1:'16:14',pm2:'20:19',pm3:null},
];
// í† ìš”ì¼ ì‹œê°„í‘œ (10ëŒ€)
const SCHEDULE_TIMES_SAT = [
  {seq:1, am1:'05:10',am2:'08:30',pm1:'12:10',pm2:'16:10',pm3:'20:20'},
  {seq:2, am1:'05:30',am2:'08:50',pm1:'12:30',pm2:'16:35',pm3:'20:40'},
  {seq:3, am1:'05:50',am2:'09:10',pm1:'12:50',pm2:'17:00',pm3:'21:00'},
  {seq:4, am1:'06:10',am2:'09:35',pm1:'13:15',pm2:'17:25',pm3:'21:25'},
  {seq:5, am1:'06:30',am2:'10:00',pm1:'13:40',pm2:'17:50',pm3:'21:50'},
  {seq:6, am1:'06:50',am2:'10:25',pm1:'14:05',pm2:'18:15',pm3:'22:15'},
  {seq:7, am1:'07:10',am2:'10:50',pm1:'14:30',pm2:'18:40',pm3:'22:40'},
  {seq:8, am1:'07:30',am2:'11:10',pm1:'14:55',pm2:'19:05',pm3:null},
  {seq:9, am1:'07:50',am2:'11:30',pm1:'15:20',pm2:'19:30',pm3:null},
  {seq:10,am1:'08:10',am2:'11:50',pm1:'15:45',pm2:'19:55',pm3:null},
];
// ì¼ìš”ì¼/ê³µíœ´ì¼ ì‹œê°„í‘œ (8ëŒ€)
const SCHEDULE_TIMES_SUN = [
  {seq:1, am1:'05:10',am2:'08:30',pm1:'12:00',pm2:'16:00',pm3:'20:00'},
  {seq:2, am1:'05:35',am2:'08:55',pm1:'12:30',pm2:'16:30',pm3:'20:30'},
  {seq:3, am1:'06:00',am2:'09:20',pm1:'13:00',pm2:'17:00',pm3:'21:00'},
  {seq:4, am1:'06:25',am2:'09:45',pm1:'13:30',pm2:'17:30',pm3:'21:30'},
  {seq:5, am1:'06:50',am2:'10:10',pm1:'14:00',pm2:'18:00',pm3:'22:00'},
  {seq:6, am1:'07:15',am2:'10:35',pm1:'14:30',pm2:'18:30',pm3:'22:40'},
  {seq:7, am1:'07:40',am2:'11:00',pm1:'15:00',pm2:'19:00',pm3:null},
  {seq:8, am1:'08:05',am2:'11:30',pm1:'15:30',pm2:'19:30',pm3:null},
];
const EMPTY_TIMES = {am1:'-',am2:'-',pm1:'-',pm2:'-',pm3:null};
function getScheduleTimes(y,m,d){
  if(isSun(y,m,d)||isHoliday(y,m,d)) return SCHEDULE_TIMES_SUN;
  if(isSat(y,m,d)) return SCHEDULE_TIMES_SAT;
  return SCHEDULE_TIMES;
}

// íšŒì‚¬ ë§Œê·¼ ê¸°ì¤€
const COMPANY_FULLWORK = {ì›”:21,í™”:20,ìˆ˜:20,ëª©:21,ê¸ˆ:21,í† :21,ì¼:21};
const SP_FULLWORK = 21; // SP ìš´ì „ìëŠ” ìš”ì¼ ë¬´ê´€ ë§Œê·¼ 21

// ìš”ì¼ë³„ ìµœëŒ€ ìš´í–‰ ìˆœë²ˆ (í† :10ëŒ€, ì¼/ê³µíœ´ì¼:8ëŒ€, í‰ì¼:16ëŒ€)
function maxSeqForDay(y,m,d){
  // ê³µíœ´ì¼ ì²´í¬ë¥¼ í† ìš”ì¼ë³´ë‹¤ ë¨¼ì € (í† ìš”ì¼ ê³µíœ´ì¼ â†’ 8ëŒ€, ì¼ë°˜ í† ìš”ì¼ â†’ 10ëŒ€)
  if(isHoliday(y,m,d)) return 8;
  if(isSat(y,m,d)) return 10;
  if(isSun(y,m,d)) return 8;
  return 16;
}

const DAYNAMES = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
// â”€â”€ ê³µíœ´ì¼ (ê³ ì • + ìŒë ¥ í•˜ë“œì½”ë”©) â”€â”€
const LUNAR_HOLIDAYS = {
  2025:['2025-01-28','2025-01-29','2025-01-30','2025-05-05','2025-10-05','2025-10-06','2025-10-07'],
  2026:['2026-02-16','2026-02-17','2026-02-18','2026-05-24','2026-09-24','2026-09-25','2026-09-26'],
  2027:['2027-02-06','2027-02-07','2027-02-08','2027-05-13','2027-10-13','2027-10-14','2027-10-15'],
};
function getHolidays(y){
  const s = new Set();
  const fixed = ['01-01','03-01','05-05','06-06','08-15','10-03','10-09','12-25'];
  fixed.forEach(d=>s.add(`${y}-${d}`));
  (LUNAR_HOLIDAYS[y]||[]).forEach(d=>s.add(d));

  // â”€â”€ ëŒ€ì²´ê³µíœ´ì¼ ìë™ ê³„ì‚° â”€â”€
  // ëŒ€ìƒ: ì‚¼ì¼ì ˆ, ì–´ë¦°ì´ë‚ , ê´‘ë³µì ˆ, ê°œì²œì ˆ, í•œê¸€ë‚ , ì„±íƒ„ì ˆ (2023ë…„ ë²•ê°œì •)
  const subEligibleFixed = ['03-01','05-05','08-15','10-03','10-09','12-25'];
  subEligibleFixed.forEach(md=>{
    const [mm,dd] = md.split('-').map(Number);
    const dt = new Date(y, mm-1, dd);
    const dow = dt.getDay(); // 0=Sun, 6=Sat
    if(dow===0||dow===6){
      const next = new Date(dt);
      next.setDate(next.getDate() + (dow===0?1:2)); // Sunâ†’Mon, Satâ†’Mon
      let nk = `${y}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`;
      while(s.has(nk)){ next.setDate(next.getDate()+1); nk=`${y}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`; }
      s.add(nk);
    }
  });
  // ì„¤/ì¶”ì„ 3ì¼ ì¤‘ ì¼ìš”ì¼ì— ê±¸ë¦¬ë©´ ëŒ€ì²´ê³µíœ´ì¼
  const lunarDates = (LUNAR_HOLIDAYS[y]||[]);
  const seolChuseok = lunarDates.filter(d=>{
    // ì„¤(1~2ì›”)/ì¶”ì„(9~10ì›”) 3ì¼ ì—°íœ´ë§Œ â€” ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ (5ì›”) ì œì™¸
    const mm = parseInt(d.split('-')[1]);
    return mm<=3 || mm>=8;
  });
  seolChuseok.forEach(d=>{
    const [yy,mm,dd] = d.split('-').map(Number);
    const dt = new Date(yy, mm-1, dd);
    if(dt.getDay()===0){ // ì¼ìš”ì¼
      const dates = seolChuseok.map(x=>{const p=x.split('-').map(Number);return new Date(p[0],p[1]-1,p[2]);});
      const lastDate = new Date(Math.max(...dates.filter(x=>Math.abs(x-dt)<4*86400000).map(x=>x.getTime())));
      const next = new Date(lastDate); next.setDate(next.getDate()+1);
      let nk = `${y}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`;
      while(s.has(nk)){ next.setDate(next.getDate()+1); nk=`${y}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`; }
      s.add(nk);
    }
  });
  // ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚  ëŒ€ì²´ê³µíœ´ì¼ (ìŒë ¥ 4/8, ì£¼ë§ì´ë©´ ë‹¤ìŒ í‰ì¼)
  const buddhaDate = lunarDates.find(d=>{
    const mm = parseInt(d.split('-')[1]);
    return mm>=4 && mm<=6; // 4~6ì›” ì¤‘ ìŒë ¥ ê³µíœ´ì¼ = ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ 
  });
  if(buddhaDate){
    const [by,bm,bd] = buddhaDate.split('-').map(Number);
    const bdt = new Date(by, bm-1, bd);
    const bdow = bdt.getDay();
    if(bdow===0||bdow===6){
      const bnext = new Date(bdt);
      bnext.setDate(bnext.getDate() + (bdow===0?1:2));
      let bnk = `${y}-${String(bnext.getMonth()+1).padStart(2,'0')}-${String(bnext.getDate()).padStart(2,'0')}`;
      while(s.has(bnk)){ bnext.setDate(bnext.getDate()+1); bnk=`${y}-${String(bnext.getMonth()+1).padStart(2,'0')}-${String(bnext.getDate()).padStart(2,'0')}`; }
      s.add(bnk);
    }
  }
  return s;
}
function isHoliday(y,m,d){
  const k=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  return getHolidays(y).has(k);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì•± ìƒíƒœ (State)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = {
  year: 2026,
  month: 2,
  activeTab: 'monthly',
  currentWeek: 1,
  drivers: [],
  baseDate: '2026-01-01',
  baseOrder: [...DEFAULT_BASE_VEHICLES], // ê¸°ì¤€ì¼ ìˆœë²ˆ1~16 ì°¨ëŸ‰
  scheduleData: {}, // key: "YYYY-M" â†’ {driverId: {day: value}}
  notesData: {},    // key: "YYYY-M" â†’ {driverId: {day: note}}
  manuallyCleared: {}, // key: "YYYY-M" â†’ {"driverId:day": true} â€” ìˆ˜ë™ ì‚­ì œ ì¶”ì 
  shiftOverrides: {},  // key: "YYYY-M" â†’ {"driverId:day": "PM"} â€” AMí•„ëŸ¬ê°€ PMê³µì„ ì±„ìš¸ ë•Œ ì‹œê°„ëŒ€ ì˜¤ë²„ë¼ì´ë“œ
  history: [],      // undo stack [{key, driverId, day, oldVal, oldNote}]
  // cell edit state
  editCell: null,   // {key, driverId, day}
  // drag-select state
  dragStart: null,
  dragCells: [],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function daysInMonth(y,m){return new Date(y,m,0).getDate();}
function dayOfWeek(y,m,d){return new Date(y,m-1,d).getDay();} // 0=ì¼, 6=í† 
function dayName(y,m,d){return DAYNAMES[dayOfWeek(y,m,d)];}
function isSat(y,m,d){return dayOfWeek(y,m,d)===6;}
function isSun(y,m,d){return dayOfWeek(y,m,d)===0;}
function isWed(y,m,d){return dayOfWeek(y,m,d)===3;}

// ê¸°ì¤€ì¼ë¡œë¶€í„° ë‚ ì§œì˜ ì˜¤í”„ì…‹ (ì¼ìˆ˜)
function dayOffset(y,m,d){
  const base = new Date(S.baseDate);
  const target = new Date(y,m-1,d);
  return Math.round((target - base) / 86400000);
}

// ìˆœë²ˆ pos(1~16) ì— í•´ë‹¹í•˜ëŠ” ì°¨ëŸ‰ë²ˆí˜¸ (Dì¼ ì˜¤í”„ì…‹, í•˜ë£¨ 3ì¹¸ ë¡œí…Œì´ì…˜)
function vehicleAtPos(pos, D){
  const shift = ((D * 3) % 16 + 16) % 16;
  const idx = ((pos - 1 - shift) % 16 + 16) % 16;
  return S.baseOrder[idx];
}

// ì°¨ëŸ‰ë²ˆí˜¸ Vì˜ Dì¼ ì˜¤í”„ì…‹ì—ì„œì˜ ìˆœë²ˆ(1~16, í•˜ë£¨ 3ì¹¸ ë¡œí…Œì´ì…˜)
function posOfVehicle(vehicleNum, D){
  const j = S.baseOrder.indexOf(vehicleNum);
  if(j<0) return null;
  const shift = ((D * 3) % 16 + 16) % 16;
  return ((j + shift) % 16) + 1;
}

// ìš´ì „ìì˜ í•´ë‹¹ì¼ ê·¼ë¬´ ì‹œê°„ëŒ€ ê²°ì • (ì˜¤ì „/ì˜¤í›„ ìë™ êµëŒ€)
// ê·œì¹™: íœ´ë¬´ì¼ì„ ì§€ë‚  ë•Œë§ˆë‹¤ ì˜¤ì „â†”ì˜¤í›„ í† ê¸€
// í˜ì–´ì˜ ì²« ë²ˆì§¸(ì°¨ëŸ‰ ìˆìŒ): ì²« êµ¬ê°„ PM â†’ íœ´ë¬´ í›„ AM â†’ íœ´ë¬´ í›„ PM â†’ ...
// í˜ì–´ì˜ ë‘ ë²ˆì§¸(ì°¨ëŸ‰ ì—†ìŒ): ì²« êµ¬ê°„ AM â†’ íœ´ë¬´ í›„ PM â†’ íœ´ë¬´ í›„ AM â†’ ...
function getShiftForDay(y, m, driverId, day){
  // shiftOverrides ì²´í¬: AMí•„ëŸ¬ê°€ PMê³µì„ì„ ì±„ìš´ ê²½ìš° í•´ë‹¹ ì¼ì˜ ì‹œê°„ëŒ€ë¥¼ PMìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ
  const oKey = schedKey(y, m);
  if(S.shiftOverrides[oKey]?.[driverId+':'+day]) return S.shiftOverrides[oKey][driverId+':'+day];
  const dr = S.drivers.find(d=>d.id===driverId);
  if(!dr) return 'AM';
  const isFirst = !!(dr.vehicle && dr.vehicle!=='');
  const dayOffIdx = DAYNAMES.indexOf(dr.dayOff);
  if(dayOffIdx < 0) return isFirst ? 'AM' : 'PM';
  // day 1 ~ day-1 ì¤‘ íœ´ë¬´ ìš”ì¼ íšŸìˆ˜ ì¹´ìš´íŠ¸
  let toggleCount = 0;
  for(let d=1; d<day; d++){
    if(dayOfWeek(y,m,d) === dayOffIdx) toggleCount++;
  }
  if(isFirst){
    return (toggleCount % 2 === 0) ? 'PM' : 'AM';
  } else {
    return (toggleCount % 2 === 0) ? 'AM' : 'PM';
  }
}

function schedKey(y,m){return `${y}-${m}`;}
function getSchedule(y,m){
  const k = schedKey(y,m);
  if(!S.scheduleData[k]) S.scheduleData[k]={};
  return S.scheduleData[k];
}
function getNote(y,m){
  const k = schedKey(y,m);
  if(!S.notesData[k]) S.notesData[k]={};
  return S.notesData[k];
}
function getCellVal(y,m,driverId,day){
  const sc = getSchedule(y,m);
  if(!sc[driverId]) return null;
  return sc[driverId][day] !== undefined ? sc[driverId][day] : null;
}
function setCellVal(y,m,driverId,day,val){
  const sc = getSchedule(y,m);
  if(!sc[driverId]) sc[driverId]={};
  sc[driverId][day] = val;
}
function getCellNote(y,m,driverId,day){
  const nt = getNote(y,m);
  if(!nt[driverId]) return '';
  return nt[driverId][day] || '';
}
function setCellNote(y,m,driverId,day,note){
  const nt = getNote(y,m);
  if(!nt[driverId]) nt[driverId]={};
  nt[driverId][day] = note;
}

// ìˆ˜ë™ ì‚­ì œ ì¶”ì  í—¬í¼ (ì›ë˜ ê°’ ì €ì¥: true=ìˆœë²ˆ, 'ìˆ˜'=ìˆ˜í•©)
function markCleared(y,m,driverId,day,origVal){ const k=schedKey(y,m); if(!S.manuallyCleared[k]) S.manuallyCleared[k]={}; S.manuallyCleared[k][driverId+':'+day]=origVal||true; }
function unmarkCleared(y,m,driverId,day){ const k=schedKey(y,m); if(S.manuallyCleared[k]) delete S.manuallyCleared[k][driverId+':'+day]; }
function isCleared(y,m,driverId,day){ const k=schedKey(y,m); return !!(S.manuallyCleared[k]&&S.manuallyCleared[k][driverId+':'+day]); }
function getClearedVal(y,m,driverId,day){ const k=schedKey(y,m); return S.manuallyCleared[k]?S.manuallyCleared[k][driverId+':'+day]:undefined; }

// ì£¼ê°„ ê·¼ë¬´ ìƒí•œ ê²°ì •: ì´ì „ ì£¼ 6ì¼ì´ë©´ í˜„ì¬ ì£¼ 5ì¼, ì•„ë‹ˆë©´ 6ì¼
function getWeekMaxForDriver(driverId, wk, weeks, y, m){
  const prevWk = weeks.find(w=>w.week===wk.week-1);
  if(!prevWk) return 6;
  let prevCount = 0;
  for(let dd=prevWk.start;dd<=prevWk.end;dd++){
    const dv = getCellVal(y,m,driverId,dd);
    if(dv!==null&&dv!==undefined) prevCount++;
  }
  return prevCount >= 6 ? 5 : 6;
}

// ëŒ€ì²´ê°€ëŠ¥ ì—¬ë¶€ í™•ì¥ íŒì • (ëª¨ë“  ìš´ì „ì íƒ€ì… ì§€ì›)
function canFillVacancyExpanded(driverId, day){
  const y=S.year, m=S.month;
  const dr = S.drivers.find(d=>d.id===driverId);
  if(!dr||!dr.active) return false;
  const val = getCellVal(y,m,driverId,day);
  if(val!==null && val!==undefined) return false; // ì´ë¯¸ ë°°ì •ë¨
  const isRegular = dr.vehicle && dr.vehicle!=='SP' && dr.vehicle!=='';
  // ê³ ì •ìš´ì „ìì´ë©´ì„œ ìê¸°ê°€ ê³µì„(ë¹¨ê°„ì…€)ì¸ ê²½ìš° â†’ ì´ˆë¡ ì•„ë‹˜
  if(isRegular && isCleared(y,m,driverId,day)) return false;
  // í•´ë‹¹ ë‚  ìˆ˜ë™ì‚­ì œ ê³µì„ì´ ìˆì–´ì•¼ í•˜ë©°, ì‹œê°„ëŒ€ í˜¸í™˜ì„± ì²´í¬
  // AMê³µì„ â†’ AMí•„ëŸ¬ë§Œ / PMê³µì„ â†’ AM+PM ëª¨ë‘ ê°€ëŠ¥
  const mcKey = schedKey(y,m);
  const mcData = S.manuallyCleared[mcKey];
  if(!mcData) return false;
  const fillerShift = getShiftForDay(y,m,driverId,day);
  const hasCompatibleVacancy = Object.keys(mcData).some(k=>{
    if(!k.endsWith(':'+day)) return false;
    const vacDid = parseInt(k.split(':')[0]);
    const vacShift = getShiftForDay(y,m,vacDid,day);
    // AMê³µì„ì€ AMí•„ëŸ¬ë§Œ, PMê³µì„ì€ ëˆ„êµ¬ë“  ê°€ëŠ¥
    if(vacShift==='AM' && fillerShift!=='AM') return false;
    return true;
  });
  if(!hasCompatibleVacancy) return false;
  // ì´ê·¼ë¬´ < ë§Œê·¼+2 ì²´í¬ (ì£¼ê°„ ì œí•œì€ ìˆ˜ë™ ëŒ€ì²´ ì‹œ ì ìš©í•˜ì§€ ì•ŠìŒ)
  const stats = calcDriverStats(y,m,driverId);
  const fw = calcFullWork(y,m,dr.dayOff,dr.preDayOff);
  if(stats.totalWork >= fw+2) return false;
  return true;
}

// í•´ë‹¹ ë‚ ì§œì— ë°°ì¹˜ ê°€ëŠ¥í•œ ëª¨ë“  ìš´ì „ì ëª©ë¡ (vacancyDriverId: ê³µì„ ë“œë¼ì´ë²„ID â€” ìˆ˜í•© ê³µì„ì´ë©´ 3íšŒ ì œí•œ ì ìš©)
function getAvailableDriversForDay(day, vacancyDriverId){
  const y=S.year, m=S.month;
  // ê³µì„ì˜ ì›ë˜ ê°’ì´ 'ìˆ˜'ì¸ì§€ í™•ì¸
  const isSuVacancy = vacancyDriverId ? getClearedVal(y,m,vacancyDriverId,day) === 'ìˆ˜' : false;
  const result = [];
  S.drivers.filter(dr=>dr.active).forEach(dr=>{
    const val = getCellVal(y,m,dr.id,day);
    if(val!==null && val!==undefined) return;
    const isRegular = dr.vehicle && dr.vehicle!=='SP' && dr.vehicle!=='';
    if(isRegular && isCleared(y,m,dr.id,day)) return; // ìê¸°ê°€ ë¹¨ê°„ê³µì„
    // ì‹œê°„ëŒ€ í˜¸í™˜ì„± ì²´í¬: AMê³µì„ â†’ AMí•„ëŸ¬ë§Œ / PMê³µì„ â†’ ëˆ„êµ¬ë“  ê°€ëŠ¥
    if(vacancyDriverId){
      const vacShift = getShiftForDay(y,m,vacancyDriverId,day);
      const fillerShift = getShiftForDay(y,m,dr.id,day);
      if(vacShift==='AM' && fillerShift!=='AM') return;
    }
    // ìˆ˜í•© ê³µì„ì´ë©´ í˜„ì¬ ìˆ˜í•© 3íšŒ ì´ìƒì¸ ìš´ì „ì ì œì™¸
    if(isSuVacancy){
      const stats2 = calcDriverStats(y,m,dr.id);
      if(stats2.suCount >= 3) return;
    }
    // ì´ê·¼ë¬´ < ë§Œê·¼+2 ì²´í¬ (ì£¼ê°„ ì œí•œì€ ìˆ˜ë™ ëŒ€ì²´ ì‹œ ì ìš©í•˜ì§€ ì•ŠìŒ)
    const stats = calcDriverStats(y,m,dr.id);
    const fw = calcFullWork(y,m,dr.dayOff,dr.preDayOff);
    if(stats.totalWork >= fw+2) return;
    const isSP = dr.vehicle==='SP';
    const isPair = !dr.vehicle||dr.vehicle==='';
    result.push({driverId:dr.id, name:dr.name, vehicle:dr.vehicle||'-', shift:dr.shift, dayOff:dr.dayOff, totalWork:stats.totalWork, fullWork:fw, suCount:stats.suCount, type:isSP?'SP':isPair?'ì˜¤í›„ì¡°':'ê³ ì •'});
  });
  // ì •ë ¬: SP ìš°ì„  â†’ ì˜¤í›„ì¡° â†’ ê³ ì •, ê·¼ë¬´ëŸ‰ ì˜¤ë¦„ì°¨ìˆœ
  const order = {SP:0,'ì˜¤í›„ì¡°':1,'ê³ ì •':2};
  result.sort((a,b)=>(order[a.type]||0)-(order[b.type]||0) || a.totalWork-b.totalWork);
  return result;
}

// í•´ë‹¹ ë‚ ì§œì˜ ë¹¨ê°„ ê³µì„ ëª©ë¡ (ìˆ˜ë™ì‚­ì œë§Œ)
function getVacanciesForDay(day){
  const y=S.year, m=S.month;
  const mcKey = schedKey(y,m);
  const mcData = S.manuallyCleared[mcKey];
  if(!mcData) return [];
  const D = dayOffset(y,m,day);
  const result = [];
  Object.keys(mcData).forEach(k=>{
    const parts = k.split(':');
    if(parseInt(parts[1])!==day) return;
    const did = parseInt(parts[0]);
    const dr = S.drivers.find(d=>d.id===did);
    if(!dr) return;
    const origVal = mcData[k];
    const seq = (origVal === 'ìˆ˜') ? null : posOfVehicle(dr.vehicle, D);
    result.push({driverId:did, name:dr.name, seq:seq, vehicle:dr.vehicle, isSu: origVal==='ìˆ˜'});
  });
  result.sort((a,b)=>(a.seq||0)-(b.seq||0));
  return result;
}

// ë§Œê·¼ ìˆ˜ ê³„ì‚°: í•´ë‹¹ì›”ë‚ ì§œìˆ˜ - íœ´ë¬´ì¼ìˆ˜ - íœ´ë¬´ì „ì¼ìˆ˜ - ë²•ì •ê³µíœ´ì¼ìˆ˜ (ê²¹ì¹˜ë©´ ì¤‘ë³µì œì™¸)
function calcFullWork(y,m,dayOff,preDayOff){
  const days = daysInMonth(y,m);
  const hols = getHolidays(y);
  const dayOffIdx = DAYNAMES.indexOf(dayOff);
  const preDayOffIdx = preDayOff ? DAYNAMES.indexOf(preDayOff) : (dayOffIdx + 6) % 7;
  let workDays = 0;
  for(let d=1;d<=days;d++){
    const dow = dayOfWeek(y,m,d);
    const k = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(dow!==dayOffIdx && dow!==preDayOffIdx && !hols.has(k)) workDays++;
  }
  return workDays;
}

// í†µê³„ ê³„ì‚° (íŠ¹ì • ìš´ì „ì)
function calcDriverStats(y,m,driverId){
  const days = daysInMonth(y,m);
  let totalWork=0, suCount=0;
  for(let d=1;d<=days;d++){
    const v = getCellVal(y,m,driverId,d);
    if(v !== null && v !== undefined){
      if(v === 'ìˆ˜') suCount++;
      else if(typeof v === 'number' && v>=1 && v<=16) totalWork++;
      else if(typeof v === 'string' && v !== 'ìˆ˜' && !isNaN(parseInt(v))) totalWork++;
    }
  }
  const driver = S.drivers.find(dr=>dr.id===driverId);
  const dayOffKey = driver ? driver.dayOff : 'ì›”';
  const preDayOffKey = driver ? driver.preDayOff : undefined;
  // ë§Œê·¼ìˆ˜ ê³µì‹: í•´ë‹¹ì›”ë‚ ì§œìˆ˜ - íœ´ë¬´ì¼ìˆ˜ - íœ´ë¬´ì „ì¼ìˆ˜ - ë²•ì •ê³µíœ´ì¼ìˆ˜
  const compFW = calcFullWork(y,m,dayOffKey,preDayOffKey);
  const total = totalWork + suCount;
  const over = total - compFW;
  return {totalWork:total, suCount, fullWork:compFW, compFW, over};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìë™ ë°°ì¹˜ ë¡œì§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoGenerate(){
  showConfirm('ì´ë²ˆ ë‹¬ ê·¼ë¬´í‘œë¥¼ ìë™ìœ¼ë¡œ ë°°ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><small>ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</small>', ()=>{
    const y = S.year, m = S.month;
    const days = daysInMonth(y,m);
    const key = schedKey(y,m);
    const weeks = getWeeksInMonth(y,m);
    S.scheduleData[key] = {};
    S.manuallyCleared[key] = {};
    S.shiftOverrides[key] = {};

    // ì „ì²´ ì´ˆê¸°í™”
    S.drivers.filter(dr=>dr.active).forEach(dr=>{ S.scheduleData[key][dr.id] = {}; });

    // í—¬í¼: ì£¼ ë‚´ ê·¼ë¬´ì¼ìˆ˜
    function weekWorkCount(driverId, wk){
      const dd = S.scheduleData[key][driverId]||{};
      return Object.keys(dd).filter(d=>{const n=parseInt(d);return n>=wk.start&&n<=wk.end&&dd[d]!==null&&dd[d]!==undefined;}).length;
    }
    // í—¬í¼: ì£¼ê°„ ê·¼ë¬´ ìƒí•œ (ì´ì „ ì£¼ 6ì¼ì´ë©´ í˜„ì¬ ì£¼ 5ì¼)
    function weekMaxForDriver(driverId, wk){
      const prevWk = weeks.find(w=>w.week===wk.week-1);
      if(!prevWk) return 6;
      return weekWorkCount(driverId, prevWk) >= 6 ? 5 : 6;
    }
    // í—¬í¼: í˜„ì¬ ì´ ê·¼ë¬´ì¼ìˆ˜
    function totalWork(driverId){
      return Object.values(S.scheduleData[key][driverId]||{}).filter(v=>v!==null&&v!==undefined).length;
    }

    // ê³ ì • ìš´ì „ì (ì°¨ëŸ‰ ìˆìŒ, SP ì œì™¸)
    const regularDrs = S.drivers.filter(dr=>dr.active && dr.vehicle && dr.vehicle!=='SP' && dr.vehicle!=='');
    // ê³ ì • í˜ì–´ (ì°¨ëŸ‰ ì—†ìŒ, íŒŒíŠ¸ë„ˆê°€ ê³ ì •ì°¨ëŸ‰)
    const regularPairDrs = S.drivers.filter(dr=>{
      if(!dr.active || dr.vehicle) return false;
      const partner = S.drivers.find(p=>p.id===dr.id-1&&p.active);
      return partner && partner.vehicle && partner.vehicle!=='SP' && partner.vehicle!=='';
    });
    // ëª¨ë“  ê³ ì • ìš´ì „ì (ì˜¤ì „+ì˜¤í›„)
    const allFixedDrs = [...regularDrs, ...regularPairDrs];
    // SP ìš´ì „ì
    const spDrs = S.drivers.filter(dr=>dr.active && dr.vehicle==='SP');
    // SP í˜ì–´
    const spPairDrs = S.drivers.filter(dr=>{
      if(!dr.active || dr.vehicle) return false;
      const partner = S.drivers.find(p=>p.id===dr.id-1&&p.active);
      return partner && partner.vehicle==='SP';
    });
    const allSPDrs = [...spDrs, ...spPairDrs];
    const hols = getHolidays(y);

    // â”€â”€ 0ë‹¨ê³„: í¸ë„(ìˆ˜) ì„ ë°°ì¹˜ â€” í‰ì¼ ë§¤ì¼ 2ëª…, 1ì¸ë‹¹ ì›” 3íšŒ, ì‰¬ëŠ”ë‚  ìš°ì„  + ê· ë“± ë¶„ë°° â”€â”€
    const suMonthCount = {};
    S.drivers.filter(dr=>dr.active).forEach(dr=>{ suMonthCount[dr.id]=0; });
    for(let d=1;d<=days;d++){
      if(isSat(y,m,d)||isSun(y,m,d)) continue;
      const dow0 = dayOfWeek(y,m,d);
      const dk0 = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const isHol0 = hols.has(dk0);
      // SP í¬í•¨ ì „ì²´ ìš´ì „ìê°€ í¸ë„(ìˆ˜) ëŒ€ìƒ
      const candidates = [...allFixedDrs, ...allSPDrs].filter(dr => suMonthCount[dr.id] < 3);
      candidates.sort((a,b)=>{
        const countDiff = (suMonthCount[a.id]||0) - (suMonthCount[b.id]||0);
        if(countDiff !== 0) return countDiff;
        const aOff = DAYNAMES.indexOf(a.dayOff);
        const bOff = DAYNAMES.indexOf(b.dayOff);
        const aPreOff = a.preDayOff ? DAYNAMES.indexOf(a.preDayOff) : (aOff+6)%7;
        const bPreOff = b.preDayOff ? DAYNAMES.indexOf(b.preDayOff) : (bOff+6)%7;
        const aPri = dow0===aOff ? 0 : dow0===aPreOff ? 1 : isHol0 ? 2 : 3;
        const bPri = dow0===bOff ? 0 : dow0===bPreOff ? 1 : isHol0 ? 2 : 3;
        return aPri - bPri;
      });
      for(let i=0;i<Math.min(2,candidates.length);i++){
        S.scheduleData[key][candidates[i].id][d] = 'ìˆ˜';
        suMonthCount[candidates[i].id]++;
      }
    }

    // â”€â”€ 1ë‹¨ê³„: ëª¨ë“  ê³ ì • ìš´ì „ì ë°°ì¹˜ (ì˜¤ì „/ì˜¤í›„ ìë™ êµëŒ€) â”€â”€
    // ê³ ì • ìš´ì „ì + í˜ì–´ ëª¨ë‘ ë™ì¼ ë¡œì§: ìê¸° ì°¨ëŸ‰ ìˆœë²ˆìœ¼ë¡œ ë°°ì¹˜
    allFixedDrs.forEach(dr=>{
      // ì°¨ëŸ‰ ë²ˆí˜¸: ìì‹ ì´ ê°€ì§„ vehicle ë˜ëŠ” íŒŒíŠ¸ë„ˆì˜ vehicle
      const veh = dr.vehicle || (S.drivers.find(p=>p.id===dr.id-1&&p.active)||{}).vehicle;
      if(!veh) return;
      const compFW = calcFullWork(y,m,dr.dayOff,dr.preDayOff);
      const suCount = suMonthCount[dr.id] || 0;
      const maxWork = compFW - suCount;
      const dayOffIdx = DAYNAMES.indexOf(dr.dayOff);
      const preDayOffIdx = dr.preDayOff ? DAYNAMES.indexOf(dr.preDayOff) : (dayOffIdx + 6) % 7;
      let workCount = 0;
      // 1ì°¨: ì¼ë°˜ ê·¼ë¬´ì¼ (dayOff, preDayOff, holiday ì œì™¸)
      for(let d=1;d<=days;d++){
        if(workCount >= maxWork) break;
        const dow = dayOfWeek(y,m,d);
        if(dow === dayOffIdx) continue;
        if(dow === preDayOffIdx) continue;
        const dk = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        if(hols.has(dk)) continue;
        if(S.scheduleData[key][dr.id][d] === 'ìˆ˜') continue;
        const wk = weeks.find(w=>d>=w.start&&d<=w.end);
        if(wk && weekWorkCount(dr.id,wk) >= weekMaxForDriver(dr.id,wk)) continue;
        const D = dayOffset(y,m,d);
        const pos = posOfVehicle(veh, D);
        const maxSeq = maxSeqForDay(y,m,d);
        if(pos !== null && pos <= maxSeq){ S.scheduleData[key][dr.id][d] = pos; workCount++; }
      }
      // 2ì°¨: ë¶€ì¡±ë¶„ ë³´ì¶© â€” íœ´ë¬´ì „ì¼/ê³µíœ´ì¼
      if(workCount < maxWork){
        for(let d=1;d<=days;d++){
          if(workCount >= maxWork) break;
          const dow = dayOfWeek(y,m,d);
          if(dow === dayOffIdx) continue;
          const dk = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          if(dow !== preDayOffIdx && !hols.has(dk)) continue;
          if(S.scheduleData[key][dr.id][d] != null) continue;
          const wk = weeks.find(w=>d>=w.start&&d<=w.end);
          if(wk && weekWorkCount(dr.id,wk) >= weekMaxForDriver(dr.id,wk)) continue;
          const D = dayOffset(y,m,d);
          const pos = posOfVehicle(veh, D);
          const maxSeq = maxSeqForDay(y,m,d);
          if(pos !== null && pos <= maxSeq){ S.scheduleData[key][dr.id][d] = pos; workCount++; }
        }
      }
    });

    // â”€â”€ 1-cë‹¨ê³„: ì°¨ëŸ‰ ìˆœë²ˆ ì´ˆê³¼ ì‹œ ë¹ˆ ìˆœë²ˆì— ë°°ì¹˜ (ì£¼ë§/ê³µíœ´ì¼ ëŒ€ì‘) â”€â”€
    // í† (10ëŒ€)/ì¼(8ëŒ€)/ê³µíœ´ì¼(8ëŒ€)ì—ì„œ ì°¨ëŸ‰ ìˆœë²ˆ > maxSeq ì¸ ê³ ì •ìš´ì „ìì—ê²Œ ë¹ˆ ìˆœë²ˆ ë¶€ì—¬
    // 2íŒ¨ìŠ¤: (1) ì¼ë°˜ì¼ ìš°ì„ , (2) íœ´ë¬´ì „ë‚ ë„ í—ˆìš©
    allFixedDrs.forEach(dr=>{
      const compFW = calcFullWork(y,m,dr.dayOff,dr.preDayOff);
      const dayOffIdx = DAYNAMES.indexOf(dr.dayOff);
      const preDayOffIdx1c = dr.preDayOff ? DAYNAMES.indexOf(dr.preDayOff) : (dayOffIdx + 6) % 7;
      let tw = totalWork(dr.id);
      if(tw >= compFW) return;
      // 1íŒ¨ìŠ¤: íœ´ë¬´ì „ë‚  ì œì™¸
      for(let d=1;d<=days;d++){
        if(tw >= compFW) break;
        const dow = dayOfWeek(y,m,d);
        if(dow === dayOffIdx) continue;
        if(dow === preDayOffIdx1c) continue;
        if(S.scheduleData[key][dr.id][d] != null) continue;
        const wk = weeks.find(w=>d>=w.start&&d<=w.end);
        if(wk && weekWorkCount(dr.id,wk)>=weekMaxForDriver(dr.id,wk)) continue;
        const maxSeq = maxSeqForDay(y,m,d);
        const myShift = getShiftForDay(y,m,dr.id,d);
        const taken = new Set();
        S.drivers.filter(dd=>dd.active).forEach(dd=>{
          if(getShiftForDay(y,m,dd.id,d) !== myShift) return;
          const v = S.scheduleData[key][dd.id]?.[d];
          if(typeof v==='number') taken.add(v);
        });
        for(let seq=1;seq<=maxSeq;seq++){
          if(!taken.has(seq)){
            S.scheduleData[key][dr.id][d] = seq;
            tw++;
            break;
          }
        }
      }
      // 2íŒ¨ìŠ¤: íœ´ë¬´ì „ë‚ ë„ í¬í•¨
      if(tw < compFW){
        for(let d=1;d<=days;d++){
          if(tw >= compFW) break;
          const dow = dayOfWeek(y,m,d);
          if(dow === dayOffIdx) continue;
          if(dow !== preDayOffIdx1c) continue; // ì´ íŒ¨ìŠ¤ëŠ” íœ´ë¬´ì „ë‚ ë§Œ
          if(S.scheduleData[key][dr.id][d] != null) continue;
          const wk = weeks.find(w=>d>=w.start&&d<=w.end);
          if(wk && weekWorkCount(dr.id,wk)>=weekMaxForDriver(dr.id,wk)) continue;
          const maxSeq = maxSeqForDay(y,m,d);
          const myShift = getShiftForDay(y,m,dr.id,d);
          const taken = new Set();
          S.drivers.filter(dd=>dd.active).forEach(dd=>{
            if(getShiftForDay(y,m,dd.id,d) !== myShift) return;
            const v = S.scheduleData[key][dd.id]?.[d];
            if(typeof v==='number') taken.add(v);
          });
          for(let seq=1;seq<=maxSeq;seq++){
            if(!taken.has(seq)){
              S.scheduleData[key][dr.id][d] = seq;
              tw++;
              break;
            }
          }
        }
      }
    });

    // â”€â”€ 2ë‹¨ê³„: SP ê³µì„ ëŒ€ì²´ ë°°ì¹˜ (ì˜¤ì „/ì˜¤í›„ ê°ê°) â”€â”€
    for(let d=1;d<=days;d++){
      const dn = dayName(y,m,d);
      const D = dayOffset(y,m,d);
      const maxSeq = maxSeqForDay(y,m,d);
      const wkSP = weeks.find(w=>d>=w.start&&d<=w.end);

      for(const shift of ['AM','PM']){
        // ì´ ì‹œê°„ëŒ€ì— ì´ë¯¸ ë°°ì •ëœ ìˆœë²ˆ ìˆ˜ì§‘
        const takenSeqs = new Set();
        S.drivers.filter(dr=>dr.active).forEach(dr=>{
          if(getShiftForDay(y,m,dr.id,d) !== shift) return;
          const v = S.scheduleData[key][dr.id]?.[d];
          if(v!==null && v!==undefined && typeof v==='number') takenSeqs.add(v);
        });
        // ë¹ˆ ìˆœë²ˆ ì°¾ê¸°
        const openSeqs = [];
        for(let seq=1;seq<=maxSeq;seq++){
          if(!takenSeqs.has(seq)) openSeqs.push(seq);
        }
        if(openSeqs.length===0) continue;
        // ì´ ì‹œê°„ëŒ€ì˜ ê°€ìš© SP (í•´ë‹¹ì¼ì— ì´ shiftì¸ SPë§Œ, íœ´ë¬´ì „ë‚  í¬í•¨í•˜ë˜ ìˆœìœ„ ë’¤)
        const availSP = allSPDrs.filter(sp=>{
          if(getShiftForDay(y,m,sp.id,d) !== shift) return false;
          if(dn===sp.dayOff) return false;
          const ex = S.scheduleData[key][sp.id]?.[d];
          if(ex!==null&&ex!==undefined) return false;
          if(totalWork(sp.id) >= calcFullWork(y,m,sp.dayOff,sp.preDayOff)+2) return false;
          if(wkSP && weekWorkCount(sp.id,wkSP)>=weekMaxForDriver(sp.id,wkSP)) return false;
          return true;
        }).sort((a,b)=>{
          // íœ´ë¬´ì „ë‚  ì•„ë‹Œ ì‚¬ëŒ ìš°ì„ 
          const aPdo = dn===(a.preDayOff||DAYNAMES[(DAYNAMES.indexOf(a.dayOff)+6)%7]) ? 1 : 0;
          const bPdo = dn===(b.preDayOff||DAYNAMES[(DAYNAMES.indexOf(b.dayOff)+6)%7]) ? 1 : 0;
          if(aPdo!==bPdo) return aPdo-bPdo;
          return (totalWork(a.id)-calcFullWork(y,m,a.dayOff,a.preDayOff)) - (totalWork(b.id)-calcFullWork(y,m,b.dayOff,b.preDayOff));
        });
        let spIdx = 0;
        openSeqs.forEach(seq=>{
          if(spIdx >= availSP.length) return;
          S.scheduleData[key][availSP[spIdx].id][d] = seq;
          spIdx++;
        });
      }
    }

    // â”€â”€ 3ë‹¨ê³„: ê³ ì •ê·¼ë¬´ì ì´ˆê³¼ í•´ì†Œ â”€â”€
    allFixedDrs.forEach(dr=>{
      const st = calcDriverStats(y,m,dr.id);
      if(st.over <= 0) return;
      let toRemove = st.over;
      for(let d=days;d>=1&&toRemove>0;d--){
        const v = S.scheduleData[key][dr.id]?.[d];
        if(v!==null&&v!==undefined&&v!=='ìˆ˜'&&typeof v==='number'){
          S.scheduleData[key][dr.id][d] = null;
          toRemove--;
        }
      }
    });

    // â”€â”€ 4ë‹¨ê³„: SP ë°¸ëŸ°ìŠ¤ â€” overâ†’under ì´ë™ â”€â”€
    for(let pass=0;pass<20;pass++){
      let moved = false;
      const overList = allSPDrs.filter(sp=>calcDriverStats(y,m,sp.id).over>0)
        .sort((a,b)=>calcDriverStats(y,m,b.id).over - calcDriverStats(y,m,a.id).over);
      const underList = allSPDrs.filter(sp=>calcDriverStats(y,m,sp.id).over<0)
        .sort((a,b)=>calcDriverStats(y,m,a.id).over - calcDriverStats(y,m,b.id).over);
      if(overList.length===0||underList.length===0) break;
      for(const overSP of overList){
        if(calcDriverStats(y,m,overSP.id).over<=0) continue;
        for(let d=days;d>=1;d--){
          const v = S.scheduleData[key][overSP.id]?.[d];
          if(v===null||v===undefined||v==='ìˆ˜'||typeof v!=='number') continue;
          const shiftD = getShiftForDay(y,m,overSP.id,d);
          for(const underSP of underList){
            if(calcDriverStats(y,m,underSP.id).over>=0) continue;
            if(dayName(y,m,d)===underSP.dayOff) continue;
            if(dayName(y,m,d)===(underSP.preDayOff||DAYNAMES[(DAYNAMES.indexOf(underSP.dayOff)+6)%7])) continue;
            if(getShiftForDay(y,m,underSP.id,d)!==shiftD) continue;
            const existing = S.scheduleData[key][underSP.id]?.[d];
            if(existing!==null&&existing!==undefined) continue;
            const wk6 = weeks.find(w=>d>=w.start&&d<=w.end);
            if(wk6 && weekWorkCount(underSP.id,wk6)>=weekMaxForDriver(underSP.id,wk6)) continue;
            S.scheduleData[key][underSP.id][d] = v;
            S.scheduleData[key][overSP.id][d] = null;
            moved = true;
            break;
          }
          if(calcDriverStats(y,m,overSP.id).over<=0) break;
        }
      }
      if(!moved) break;
    }

    // â”€â”€ 5ë‹¨ê³„: ì£¼ë§/ê³µíœ´ì¼ ì •ì› ê°•ì œ ë³´ì¥ â€” í†  10ëŒ€, ì¼/ê³µíœ´ì¼ 8ëŒ€ â”€â”€
    for(let d=1;d<=days;d++){
      if(!isSat(y,m,d) && !isSun(y,m,d) && !isHoliday(y,m,d)) continue;
      const maxSeq = maxSeqForDay(y,m,d);
      const dn = dayName(y,m,d);
      const wk7 = weeks.find(w=>d>=w.start&&d<=w.end);

      for(const shift of ['AM','PM']){
        // ì´ ì‹œê°„ëŒ€ ìš´ì „ì
        const shiftDrs = S.drivers.filter(dr=>dr.active && getShiftForDay(y,m,dr.id,d)===shift);
        // (A) ìœ íš¨í•œ ìˆœë²ˆë§Œ ë‚¨ê¸°ê³  ì´ˆê³¼/ì¤‘ë³µ/ë²”ìœ„ë°– ì œê±°
        const validPos = {};
        shiftDrs.forEach(dr=>{
          const v = S.scheduleData[key][dr.id]?.[d];
          const vn = typeof v==='string' ? parseInt(v) : v;
          if(typeof vn==='number' && !isNaN(vn) && vn>=1 && vn<=maxSeq && !validPos[vn]){
            validPos[vn] = dr.id;
          } else if(v!==null && v!==undefined && v!=='ìˆ˜'){
            S.scheduleData[key][dr.id][d] = null;
          }
        });
        // (B) ë¹ˆ ìˆœë²ˆ ì±„ìš°ê¸° â€” ê³ ì • ë¨¼ì € +2, ê·¸ ë‹¤ìŒ SP +2, íœ´ë¬´ì „ë‚ ì€ ìˆœìœ„ ë’¤
        for(let seq=1;seq<=maxSeq;seq++){
          if(validPos[seq]) continue;
          const cand = shiftDrs.filter(dr=>{
            if(dn===dr.dayOff) return false;
            const ex = S.scheduleData[key][dr.id]?.[d];
            if(ex!==null&&ex!==undefined) return false;
            if(wk7&&weekWorkCount(dr.id,wk7)>=weekMaxForDriver(dr.id,wk7)) return false;
            const tw = totalWork(dr.id);
            const fw = calcFullWork(y,m,dr.dayOff,dr.preDayOff);
            if(tw>=fw+2) return false; // ê³ ì •+SP ëª¨ë‘ +2ê¹Œì§€ í—ˆìš©
            return true;
          }).sort((a,b)=>{
            // 1) íœ´ë¬´ì „ë‚  ì•„ë‹Œ ì‚¬ëŒ ìš°ì„ 
            const aPdo = a.preDayOff||DAYNAMES[(DAYNAMES.indexOf(a.dayOff)+6)%7];
            const bPdo = b.preDayOff||DAYNAMES[(DAYNAMES.indexOf(b.dayOff)+6)%7];
            const aIsPdo = dn===aPdo ? 1 : 0;
            const bIsPdo = dn===bPdo ? 1 : 0;
            if(aIsPdo!==bIsPdo) return aIsPdo-bIsPdo;
            // 2) ê³ ì • ë¨¼ì €, SP ë‚˜ì¤‘
            const aIsSP = allSPDrs.some(sp=>sp.id===a.id) ? 1 : 0;
            const bIsSP = allSPDrs.some(sp=>sp.id===b.id) ? 1 : 0;
            if(aIsSP!==bIsSP) return aIsSP-bIsSP;
            // 3) ì ì(ë¶€ì¡±ë¶„) í° ì‚¬ëŒ ìš°ì„ 
            return (totalWork(a.id)-calcFullWork(y,m,a.dayOff,a.preDayOff)) - (totalWork(b.id)-calcFullWork(y,m,b.dayOff,b.preDayOff));
          });
          if(cand.length>0){
            S.scheduleData[key][cand[0].id][d] = seq;
            validPos[seq] = cand[0].id;
          }
        }
      }
    }

    // â”€â”€ 6ë‹¨ê³„: í‰ì¼ ì •ì› ê°•ì œ ë³´ì¥ â€” ì˜¤ì „ 16ëŒ€, ì˜¤í›„ 16ëŒ€ â”€â”€
    for(let d=1;d<=days;d++){
      if(isSat(y,m,d)||isSun(y,m,d)||isHoliday(y,m,d)) continue; // í‰ì¼ë§Œ
      const maxSeq6 = 16;
      const dn6 = dayName(y,m,d);
      const allActive = S.drivers.filter(dr=>dr.active);

      for(const shift of ['AM','PM']){
        const shiftDrs6 = allActive.filter(dr=>getShiftForDay(y,m,dr.id,d)===shift);
        // í˜„ì¬ ë°°ì • ìƒíƒœ í™•ì¸
        const validPos6 = {};
        shiftDrs6.forEach(dr=>{
          const v = S.scheduleData[key][dr.id]?.[d];
          const vn6 = typeof v==='string' ? parseInt(v) : v;
          if(typeof vn6==='number' && !isNaN(vn6) && vn6>=1 && vn6<=maxSeq6 && !validPos6[vn6]){
            validPos6[vn6] = dr.id;
          }
        });
        // ë¹ˆ ìˆœë²ˆ ì±„ìš°ê¸° â€” ê³ ì • ë¨¼ì € +2, ê·¸ ë‹¤ìŒ SP +2, íœ´ë¬´ì „ë‚ ì€ ìˆœìœ„ ë’¤
        for(let seq=1;seq<=maxSeq6;seq++){
          if(validPos6[seq]) continue;
          const cand6 = shiftDrs6.filter(dr=>{
            if(dn6===dr.dayOff) return false;
            const ex = S.scheduleData[key][dr.id]?.[d];
            if(ex!==null&&ex!==undefined) return false;
            const wk6g = weeks.find(w=>d>=w.start&&d<=w.end);
            if(wk6g&&weekWorkCount(dr.id,wk6g)>=weekMaxForDriver(dr.id,wk6g)) return false;
            const tw = totalWork(dr.id);
            const fw = calcFullWork(y,m,dr.dayOff,dr.preDayOff);
            if(tw>=fw+2) return false; // ê³ ì •+SP ëª¨ë‘ +2ê¹Œì§€ í—ˆìš©
            return true;
          }).sort((a,b)=>{
            // 1) íœ´ë¬´ì „ë‚  ì•„ë‹Œ ì‚¬ëŒ ìš°ì„ 
            const aPdo6 = a.preDayOff||DAYNAMES[(DAYNAMES.indexOf(a.dayOff)+6)%7];
            const bPdo6 = b.preDayOff||DAYNAMES[(DAYNAMES.indexOf(b.dayOff)+6)%7];
            const aIsPdo6 = dn6===aPdo6 ? 1 : 0;
            const bIsPdo6 = dn6===bPdo6 ? 1 : 0;
            if(aIsPdo6!==bIsPdo6) return aIsPdo6-bIsPdo6;
            // 2) ê³ ì • ë¨¼ì €, SP ë‚˜ì¤‘
            const aIsSP6 = allSPDrs.some(sp=>sp.id===a.id) ? 1 : 0;
            const bIsSP6 = allSPDrs.some(sp=>sp.id===b.id) ? 1 : 0;
            if(aIsSP6!==bIsSP6) return aIsSP6-bIsSP6;
            // 3) ì ì í° ì‚¬ëŒ ìš°ì„ 
            return (totalWork(a.id)-calcFullWork(y,m,a.dayOff,a.preDayOff)) - (totalWork(b.id)-calcFullWork(y,m,b.dayOff,b.preDayOff));
          });
          if(cand6.length>0){
            S.scheduleData[key][cand6[0].id][d] = seq;
            validPos6[seq] = cand6[0].id;
          }
        }
      }
    }

    saveToStorage();
    renderMonthlySchedule();
    renderStats();
    showStatus('ìë™ ë°°ì¹˜ ì™„ë£Œ!');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë Œë”ë§: ì›”ê°„ ê·¼ë¬´í‘œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonthlySchedule(){
  const y = S.year, m = S.month;
  const days = daysInMonth(y,m);
  const weeks = getWeeksInMonth(y,m);
  document.getElementById('monthlyTitle').textContent = `${y}ë…„ ${m}ì›” ê·¼ë¬´í‘œ`;

  let html = `<table class="sched-table"><thead>`;

  // â”€â”€ í—¤ë” í–‰1: ë…„ì›” (colspan 5: ë²ˆí˜¸/ì°¨ëŸ‰/ì„±ëª…/íœ´ë¬´/ì¡°) â”€â”€
  html += `<tr><th class="th-main" colspan="5">${y}ë…„ ${m}ì›”</th>`;
  for(let d=1;d<=days;d++){
    const hol = isHoliday(y,m,d);
    const preHol = !hol && d<days && isHoliday(y,m,d+1);
    let cls = isSat(y,m,d)?'th-sat':isSun(y,m,d)?'th-sun':'th-day';
    const holStyle = (hol||preHol) ? ' style="background:#c8a000;color:#fff;"' : '';
    html += `<th class="${cls}"${holStyle}>${d}</th>`;
  }
  html += `<th class="th-main" colspan="5">ì§‘ê³„</th></tr>`;

  // â”€â”€ í—¤ë” í–‰2: ìš”ì¼ â”€â”€
  html += `<tr><th class="th-sub">ë²ˆí˜¸</th><th class="th-sub">ì°¨ëŸ‰</th><th class="th-sub">ì„±ëª…</th><th class="th-sub">íœ´ë¬´</th><th class="th-sub">êµ¬ë¶„</th>`;
  for(let d=1;d<=days;d++){
    const hol = isHoliday(y,m,d);
    const preHol = !hol && d<days && isHoliday(y,m,d+1);
    let cls = isSat(y,m,d)?'th-sat':isSun(y,m,d)?'th-sun':'th-day';
    const holStyle = (hol||preHol) ? ' style="background:#c8a000;color:#fff;"' : '';
    html += `<th class="${cls}" style="font-size:13px;${(hol||preHol)?'background:#c8a000;color:#fff;':''}">${dayName(y,m,d)}</th>`;
  }
  html += `<th class="th-sub">ë§Œê·¼ìˆ˜</th><th class="th-sub">ì´ê·¼ë¬´</th><th class="th-sub">ìˆ˜í•©</th><th class="th-sub">ì´ˆê³¼</th><th class="th-sub">íŠ¹ì´ì‚¬í•­</th></tr></thead><tbody>`;

  // â”€â”€ ë°ì´í„° í–‰ â”€â”€
  const activeDrivers = S.drivers.filter(dr=>dr.active).sort((a,b)=>(a.seq||a.id)-(b.seq||b.id));
  // ë‚ ì§œë³„ ê³µì„ ëª©ë¡ (ê³ ì • ìš´ì „ìê°€ ë¹„ì–´ìˆëŠ” ë‚  + ìƒì„¸ì •ë³´ + ìˆ˜ë™ì‚­ì œ ì—¬ë¶€) ë¯¸ë¦¬ ê³„ì‚°
  const vacancyMap = {}; // {d: [{driverId, name, seq, vehicle, cleared}]}
  for(let d=1;d<=days;d++){
    const dn = dayName(y,m,d);
    const D = dayOffset(y,m,d);
    const vacants = [];
    S.drivers.forEach(dr=>{
      if(!dr.active||!dr.vehicle||dr.vehicle==='SP'||dr.vehicle==='') return;
      if(dn===dr.dayOff) return;
      const v = getCellVal(y,m,dr.id,d);
      if(v===null||v===undefined){
        const pos = posOfVehicle(dr.vehicle, D);
        vacants.push({driverId:dr.id, name:dr.name, seq:pos, vehicle:dr.vehicle, cleared:isCleared(y,m,dr.id,d)});
      }
    });
    vacancyMap[d] = vacants;
  }

  activeDrivers.forEach((dr,ri)=>{
    const isRegular = dr.vehicle && dr.vehicle!=='SP' && dr.vehicle!=='';
    const even = ri%2===1 ? 'row-even':'';
    const driverStats = calcDriverStats(y,m,dr.id);

    for(const subShift of ['AM','PM']){
      html += `<tr class="${even}">`;
      if(subShift==='AM'){
        // ë¶€ìš´ì „ì(ì§ìˆ˜ ID)ëŠ” ì£¼ìš´ì „ì(id-1)ì˜ ì°¨ëŸ‰ë²ˆí˜¸ í‘œì‹œ
        let dispVeh = dr.vehicle || '';
        if(!dispVeh || dispVeh===''){
          const partner = S.drivers.find(p=>p.id===dr.id-1&&p.active);
          dispVeh = partner ? (partner.vehicle||'-') : '-';
        }
        html += `<td class="col-info" rowspan="2">${dr.seq||dr.id}</td>`;
        html += `<td class="col-info" rowspan="2">${dispVeh}</td>`;
        html += `<td class="col-name" rowspan="2"><b>${dr.name}</b></td>`;
        html += `<td class="col-info" rowspan="2">${dr.dayOff}</td>`;
      }
      html += `<td class="col-info" style="font-size:11px;padding:1px 4px;">${subShift==='AM'?'ì˜¤ì „':'ì˜¤í›„'}</td>`;

      for(let d=1;d<=days;d++){
        const dn = dayName(y,m,d);
        const isOff = dn === dr.dayOff;
        const val = getCellVal(y,m,dr.id,d);
        const note = getCellNote(y,m,dr.id,d);
        const hol = isHoliday(y,m,d);
        const preHol = !hol && d<days && isHoliday(y,m,d+1);
        const dayOffIdx = DAYNAMES.indexOf(dr.dayOff);
        const preDayOffName = dr.preDayOff || DAYNAMES[(dayOffIdx+6)%7];
        const isPreDayOff = !isOff && dn === preDayOffName;
        const shiftToday = getShiftForDay(y,m,dr.id,d);
        const isActiveRow = shiftToday === subShift;

        if(isOff && val==='ìˆ˜' && isActiveRow){
          // íœ´ë¬´ì¼ì´ì§€ë§Œ ìˆ˜í•©(ìˆ˜) ë°°ì •ëœ ì…€ â†’ ìˆ˜ í‘œì‹œ (ì´ˆë¡ë°°ê²½)
          html += `<td class="day-cell cell-su" style="background:#c8f5c8!important;color:#1a7a1a;font-weight:700;" onclick="openCellEdit(${dr.id},${d})">ìˆ˜</td>`;
        } else if(isOff && isActiveRow && (val===null||val===undefined) && canFillVacancyExpanded(dr.id, d)){
          // íœ´ë¬´ì¼ì´ì§€ë§Œ ëŒ€ì²´ê°€ëŠ¥í•œ ì…€ â†’ ì´ˆë¡ í‘œì‹œ
          html += `<td class="day-cell cell-off" style="background:#c8f5c8!important;border:2px solid #28a745!important;cursor:pointer;" onclick="openAssignModalForAvailable(${dr.id},${d})"></td>`;
        } else if(isOff){
          html += `<td class="day-cell cell-off" style="background:#fffacd!important;" onclick="openCellEdit(${dr.id},${d})"></td>`;
        } else if(!isActiveRow){
          if(isPreDayOff){
            html += `<td class="day-cell cell-pre-off" style="background:#fff9c4!important;"></td>`;
          } else {
            html += `<td class="day-cell" style="background:#f0f0f0;"></td>`;
          }
        } else {
          let cellCls = 'day-cell ';
          let display = '';
          let extraStyle = '';
          let vacancyTitle = '';
          if(val==='ìˆ˜'){ cellCls+='cell-su'; display='ìˆ˜'; }
          else if(val!==null&&val!==undefined){
            cellCls+='cell-work';
            if(isSat(y,m,d)) cellCls+=' cell-sat';
            else if(isSun(y,m,d)) cellCls+=' cell-sun';
            const wk = weeks.find(w=>d>=w.start&&d<=w.end);
            let weekCount = 0;
            if(wk){ for(let dd=wk.start;dd<=d;dd++){ const dv=getCellVal(y,m,dr.id,dd); if(dv!==null&&dv!==undefined) weekCount++; } }
            display = weekCount>0 ? String(weekCount) : '';
            if(isPreDayOff) cellCls+=' cell-pre-off';
          } else {
            if(isSat(y,m,d)) cellCls+='cell-sat';
            else if(isSun(y,m,d)) cellCls+='cell-sun';
            if(isPreDayOff) cellCls+=' cell-pre-off';
            if(isRegular && isCleared(y,m,dr.id,d)){
              extraStyle='background:#ffcccc!important;border:2px solid #dc3545!important;';
              const D2 = dayOffset(y,m,d);
              const pos = posOfVehicle(dr.vehicle, D2);
              vacancyTitle = `ê³µì„: ìˆœë²ˆ${pos} (${dr.vehicle})`;
            }
            if(canFillVacancyExpanded(dr.id, d)){
              extraStyle='background:#c8f5c8!important;border:2px solid #28a745!important;';
              vacancyTitle = 'ëŒ€ì²´ê°€ëŠ¥: ' + vacancyMap[d].filter(v=>v.cleared).map(v=>`${v.name}(${v.vehicle}ìˆœë²ˆ${v.seq})`).join(', ');
            }
          }
          if(!extraStyle){
            if(isPreDayOff) extraStyle='background:#fff9c4!important;';
          }
          if(hol||preHol) cellCls+=' cell-hol';
          if(note) cellCls+=' cell-note';
          const titleParts = [];
          if(note) titleParts.push(note);
          if(vacancyTitle) titleParts.push(vacancyTitle);
          const titleAttr = titleParts.length > 0 ? `title="${escHtml(titleParts.join(' | '))}"` : '';
          const styleAttr = extraStyle ? `style="${extraStyle}"` : '';
          html += `<td class="${cellCls}" ${titleAttr} ${styleAttr} onclick="openCellEdit(${dr.id},${d})" onmousedown="startDrag(${dr.id},${d})" onmouseenter="updateDrag(${dr.id},${d})">${display}</td>`;
        }
      }

      if(subShift==='AM'){
        const overCls = driverStats.over>0?'over-cell':driverStats.over<0?'under-cell':'sum-cell';
        html += `<td class="sum-cell" rowspan="2">${driverStats.fullWork}</td>`;
        html += `<td class="sum-cell" rowspan="2">${driverStats.totalWork}</td>`;
        html += `<td class="sum-cell" rowspan="2">${driverStats.suCount}</td>`;
        html += `<td class="${overCls}" rowspan="2">${driverStats.over>0?'+'+driverStats.over:driverStats.over}</td>`;
        html += `<td class="col-info" rowspan="2" style="min-width:80px;font-size:13px;">${dr.note||''}</td>`;
      }
      html += `</tr>`;
    }
  });

  // â”€â”€ í•˜ë‹¨ ì¼ë³„ ì§‘ê³„ (ì˜¤ì „/ì˜¤í›„/í¸ë„) â”€â”€
  const dayTotals=[];
  for(let d=1;d<=days;d++){
    let am=0,pm=0,su=0;
    activeDrivers.forEach(dr=>{
      const v=getCellVal(y,m,dr.id,d);
      if(v==='ìˆ˜') su++;
      else if(v!==null&&v!==undefined){ if(getShiftForDay(y,m,dr.id,d)==='AM') am++; else pm++; }
    });
    dayTotals.push({am,pm,su});
  }
  const sumSt='background:#d0d8ec;font-weight:700;font-size:13px;text-align:center;padding:2px 4px;border:1px solid #b0b8c8;';
  const sumLabelSt='background:#1a3a6b;color:#fff;font-weight:700;font-size:13px;padding:3px 8px;text-align:right;border:1px solid #aaa;';
  ['ğŸŒ… ì˜¤ì „','ğŸŒ† ì˜¤í›„','ğŸšŒ í¸ë„(ìˆ˜)'].forEach((label,li)=>{
    html += `<tr><td colspan="5" style="${sumLabelSt}">${label}</td>`;
    dayTotals.forEach(({am,pm,su},i)=>{
      const d=i+1;
      const hol=isHoliday(y,m,d);
      const preHol=!hol&&d<days&&isHoliday(y,m,d+1);
      const bg=(hol||preHol)?'background:#fff3cd;':'';
      const val=li===0?am:li===1?pm:su;
      html += `<td style="${sumSt}${bg}">${val||''}</td>`;
    });
    html += `<td colspan="5" style="${sumSt}"></td></tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById('scheduleTable').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í†µê³„ ì¹´ë“œ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(){
  const y=S.year,m=S.month;
  const active = S.drivers.filter(dr=>dr.active);
  let overCnt=0, underCnt=0, exactCnt=0;
  active.forEach(dr=>{
    const st = calcDriverStats(y,m,dr.id);
    if(st.over>0) overCnt++;
    else if(st.over<0) underCnt++;
    else exactCnt++;
  });
  const days = daysInMonth(y,m);
  document.getElementById('statsCards').innerHTML = `
    <div class="stat-card"><div class="sc-label">ì´ ì§ì› ìˆ˜</div><div class="sc-value">${active.length}</div><div class="sc-sub">ëª…</div></div>
    <div class="stat-card"><div class="sc-label">ì´ ì¼ìˆ˜</div><div class="sc-value">${days}</div><div class="sc-sub">ì¼</div></div>
    <div class="stat-card" style="border-left:4px solid #e07800;"><div class="sc-label">ì´ˆê³¼ê·¼ë¬´</div><div class="sc-value" style="color:#e07800;">${overCnt}</div><div class="sc-sub">ëª…</div></div>
    <div class="stat-card" style="border-left:4px solid #c0392b;"><div class="sc-label">ë¯¸ë‹¬</div><div class="sc-value" style="color:#c0392b;">${underCnt}</div><div class="sc-sub">ëª…</div></div>
    <div class="stat-card" style="border-left:4px solid #1e7e34;"><div class="sc-label">ë§Œê·¼</div><div class="sc-value" style="color:#1e7e34;">${exactCnt}</div><div class="sc-sub">ëª…</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì…€ í¸ì§‘ ëª¨ë‹¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCellEdit(driverId, day){
  const dr = S.drivers.find(d=>d.id===driverId);
  if(!dr) return;
  const y=S.year, m=S.month;
  const dn = dayName(y,m,day);
  const isOff = dn === dr.dayOff;
  const isRegular = dr.vehicle && dr.vehicle!=='SP' && dr.vehicle!=='';
  const val = getCellVal(y,m,driverId,day);

  // â”€â”€ ë””ìŠ¤íŒ¨ì²˜: ë¹¨ê°„ ê³µì„ ì…€ â†’ ë°°ì¹˜ ëª¨ë‹¬ â”€â”€
  if(isRegular && !isOff && isCleared(y,m,driverId,day) && (val===null||val===undefined)){
    openAssignModalForVacancy(driverId, day);
    return;
  }
  // â”€â”€ ë””ìŠ¤íŒ¨ì²˜: ì´ˆë¡ ëŒ€ì²´ê°€ëŠ¥ ì…€ â†’ ê³µì„ ì„ íƒ ëª¨ë‹¬ â”€â”€
  if((val===null||val===undefined) && canFillVacancyExpanded(driverId, day)){
    openAssignModalForAvailable(driverId, day);
    return;
  }

  // â”€â”€ ê¸°ì¡´ ì…€ í¸ì§‘ ëª¨ë‹¬ â”€â”€
  S.editCell = {key: schedKey(y,m), driverId, day};

  document.getElementById('cellModalTitle').textContent = `${dr.name} â€” ${m}ì›” ${day}ì¼ (${dn})`;
  document.getElementById('cellModalCtx').innerHTML = `
    <b>${dr.name}</b> | ì°¨ëŸ‰: ${dr.vehicle||'-'} | íœ´ë¬´ìš”ì¼: ${dr.dayOff}<br>
    ${isOff ? 'âš ï¸ <span style="color:#c00;">ì´ ë‚ ì€ íœ´ë¬´ì¼ì…ë‹ˆë‹¤</span>' : ''}`;

  const currentVal = getCellVal(y,m,driverId,day);
  const currentNote = getCellNote(y,m,driverId,day);
  document.getElementById('cellNoteInput').value = currentNote;

  const D = dayOffset(y,m,day);
  const weeks = getWeeksInMonth(y,m);
  const wk = weeks.find(w=>day>=w.start&&day<=w.end);
  let weekCount = 0;
  if(wk){ for(let dd=wk.start;dd<=day;dd++){ const dv=getCellVal(y,m,driverId,dd); if(dv!==null&&dv!==undefined) weekCount++; } }

  let grid = '';
  for(let i=1;i<=6;i++){
    const isSel = weekCount===i && currentVal!==null;
    grid += `<button class="seq-btn ${isSel?'active-sel':''}" onclick="selectSeqWeekly(${i},${driverId},${day},event)" style="width:56px;height:56px;">
      <div style="font-size:22px;font-weight:800;">${i}</div>
    </button>`;
  }
  document.getElementById('seqGrid').innerHTML = grid;
  openModal('cellModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°°ì¹˜ ëª¨ë‹¬: ë¹¨ê°„ ê³µì„ í´ë¦­ â†’ ë°°ì¹˜ ê°€ëŠ¥ ìš´ì „ì ë¦¬ìŠ¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAssignModalForVacancy(vacancyDriverId, day){
  const y=S.year, m=S.month;
  const dr = S.drivers.find(d=>d.id===vacancyDriverId);
  if(!dr) return;
  const dn = dayName(y,m,day);
  const D = dayOffset(y,m,day);
  const seq = posOfVehicle(dr.vehicle, D);

  document.getElementById('assignModalTitle').textContent = `ê³µì„ ë°°ì¹˜ â€” ${m}ì›” ${day}ì¼ (${dn}) ìˆœë²ˆ${seq} (${dr.vehicle})`;
  document.getElementById('assignModalCtx').innerHTML = `<b>${dr.name}</b>ì˜ ê³µì„ì„ ì±„ìš¸ ìˆ˜ ìˆëŠ” ìš´ì „ì ëª©ë¡`;

  const available = getAvailableDriversForDay(day, vacancyDriverId);
  let html = '';
  if(available.length===0){
    html = '<div class="assign-empty">ë°°ì¹˜ ê°€ëŠ¥í•œ ìš´ì „ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    available.forEach(a=>{
      const badgeCls = a.type==='SP'?'badge-sp':a.type==='ì˜¤í›„ì¡°'?'badge-pair':'badge-regular';
      html += `<div class="assign-item" onclick="performAssignment(${a.driverId},${day},${vacancyDriverId})">
        <span class="ai-name">${a.name}<span class="ai-badge ${badgeCls}">${a.type}</span></span>
        <span class="ai-info">ì°¨ëŸ‰:${a.vehicle} | ê·¼ë¬´:${a.totalWork}/${a.fullWork} | íœ´ë¬´:${a.dayOff}</span>
      </div>`;
    });
  }
  document.getElementById('assignModalList').innerHTML = html;
  openModal('assignModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°°ì¹˜ ëª¨ë‹¬: ì´ˆë¡ ì…€ í´ë¦­ â†’ ë°°ì¹˜í•  ê³µì„ ë¦¬ìŠ¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAssignModalForAvailable(fillerDriverId, day){
  const y=S.year, m=S.month;
  const dr = S.drivers.find(d=>d.id===fillerDriverId);
  if(!dr) return;
  const dn = dayName(y,m,day);

  document.getElementById('assignModalTitle').textContent = `ë°°ì¹˜ ì„ íƒ â€” ${dr.name} (${m}ì›” ${day}ì¼ ${dn})`;
  document.getElementById('assignModalCtx').innerHTML = `<b>${dr.name}</b>ì„(ë¥¼) ë°°ì¹˜í•  ìˆ˜ ìˆëŠ” ê³µì„ ëª©ë¡`;

  const allVacancies = getVacanciesForDay(day);
  // ì‹œê°„ëŒ€ í˜¸í™˜ì„± í•„í„°: AMê³µì„ â†’ AMí•„ëŸ¬ë§Œ, PMê³µì„ â†’ ëˆ„êµ¬ë“  ê°€ëŠ¥
  const fillerShift = getShiftForDay(y,m,fillerDriverId,day);
  const vacancies = allVacancies.filter(v=>{
    const vacShift = getShiftForDay(y,m,v.driverId,day);
    if(vacShift==='AM' && fillerShift!=='AM') return false;
    return true;
  });
  let html = '';
  if(vacancies.length===0){
    html = '<div class="assign-empty">ë°°ì¹˜ ê°€ëŠ¥í•œ ê³µì„ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    vacancies.forEach(v=>{
      const badge = v.isSu ? '<span class="ai-badge badge-sp">í¸ë„(ìˆ˜)</span>' : `<span class="ai-badge badge-regular">ìˆœë²ˆ${v.seq}</span>`;
      const info = v.isSu ? 'í¸ë„(ìˆ˜í•©) ë°°ì •' : `ì°¨ëŸ‰:${v.vehicle}`;
      html += `<div class="assign-item" onclick="performAssignment(${fillerDriverId},${day},${v.driverId})">
        <span class="ai-name">${v.name}ì˜ ê³µì„${badge}</span>
        <span class="ai-info">${info}</span>
      </div>`;
    });
  }
  document.getElementById('assignModalList').innerHTML = html;
  openModal('assignModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°°ì¹˜ ì‹¤í–‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function performAssignment(fillerDriverId, day, vacancyDriverId){
  const y=S.year, m=S.month;
  const vacDr = S.drivers.find(d=>d.id===vacancyDriverId);
  const fillDr = S.drivers.find(d=>d.id===fillerDriverId);
  if(!vacDr||!fillDr) return;

  // ì›ë˜ ì‚­ì œëœ ê°’ í™•ì¸: 'ìˆ˜'ë©´ ìˆ˜í•© ë°°ì¹˜, ì•„ë‹ˆë©´ ìˆœë²ˆ ë°°ì¹˜
  const clearedVal = getClearedVal(y,m,vacancyDriverId,day);
  const D = dayOffset(y,m,day);
  const seq = posOfVehicle(vacDr.vehicle, D);
  const assignVal = (clearedVal === 'ìˆ˜') ? 'ìˆ˜' : seq;

  // ìˆ˜í•© 3íšŒ ì œí•œ ì²´í¬
  if(assignVal === 'ìˆ˜'){
    const fillerStats = calcDriverStats(y,m,fillerDriverId);
    if(fillerStats.suCount >= 3){
      alert(`${fillDr.name}ì€(ëŠ”) ì´ë¯¸ ìˆ˜í•© ${fillerStats.suCount}íšŒì…ë‹ˆë‹¤. (ìµœëŒ€ 3íšŒ)`);
      return;
    }
  }

  // ì‹œê°„ëŒ€ ì˜¤ë²„ë¼ì´ë“œ ê²°ì •: AMí•„ëŸ¬ê°€ PMê³µì„ì„ ì±„ìš°ë©´ í•´ë‹¹ ì¼ PMìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ
  const fillerOrigShift = getShiftForDay(y,m,fillerDriverId,day);
  const vacShift = getShiftForDay(y,m,vacancyDriverId,day);
  const needOverride = (fillerOrigShift==='AM' && vacShift==='PM');

  // historyì— fillerì˜ ì´ì „ ìƒíƒœ ì €ì¥ (wasCleared í¬í•¨)
  const oldFillerVal = getCellVal(y,m,fillerDriverId,day);
  const oldFillerNote = getCellNote(y,m,fillerDriverId,day);
  S.history.push({key:schedKey(y,m), driverId:fillerDriverId, day, oldVal:oldFillerVal, oldNote:oldFillerNote, wasCleared:false, hadOverride:false});

  // historyì— vacancyì˜ cleared ìƒíƒœ ì €ì¥
  S.history.push({key:schedKey(y,m), driverId:vacancyDriverId, day, oldVal:null, oldNote:'', wasCleared:true, hadOverride:false});

  if(S.history.length>100){ S.history.shift(); S.history.shift(); }

  // fillerì—ê²Œ ë°°ì • (ìˆ˜í•©ì´ë©´ 'ìˆ˜', ì•„ë‹ˆë©´ ìˆœë²ˆ)
  setCellVal(y,m,fillerDriverId,day,assignVal);
  // vacancyì˜ ë¹¨ê°„ ê³µì„ í•´ì†Œ
  unmarkCleared(y,m,vacancyDriverId,day);

  // AMí•„ëŸ¬ + PMê³µì„ â†’ shiftOverridesì— PM ê¸°ë¡
  if(needOverride){
    const oKey = schedKey(y,m);
    if(!S.shiftOverrides[oKey]) S.shiftOverrides[oKey]={};
    S.shiftOverrides[oKey][fillerDriverId+':'+day] = 'PM';
    // historyì— ì˜¤ë²„ë¼ì´ë“œ ê¸°ë¡ (undo ì‹œ í•´ì†Œìš©)
    S.history[S.history.length-2].hadOverride = true;
    S.history[S.history.length-2].overrideDriverId = fillerDriverId;
    S.history[S.history.length-2].overrideDay = day;
  }

  closeModal('assignModal');
  saveToStorage();
  renderMonthlySchedule();
  renderStats();
  updateUndoBtn();
  const label = (clearedVal === 'ìˆ˜') ? 'í¸ë„(ìˆ˜)' : `ìˆœë²ˆ${seq}(${vacDr.vehicle})`;
  showStatus(`${fillDr.name} â†’ ${label} ë°°ì¹˜ ì™„ë£Œ`);
}

let _pendingCellVal = null;
function selectSeq(n,e){
  _pendingCellVal = n;
  document.querySelectorAll('.seq-btn').forEach(b=>b.classList.remove('active-sel'));
  (e||event).currentTarget.classList.add('active-sel');
}
// íŒì—… 1~6 ë²„íŠ¼ í´ë¦­ ì‹œ: ë‚´ë¶€ì ìœ¼ë¡œ ì°¨ëŸ‰ ìˆœë²ˆ(1~16) ìë™ ê²°ì •
function selectSeqWeekly(weekNum, driverId, day, e){
  const dr = S.drivers.find(d=>d.id===driverId);
  let storeVal;
  if(dr && dr.vehicle && dr.vehicle!=='SP' && dr.vehicle!==''){
    // ê³ ì • ì°¨ëŸ‰: í•´ë‹¹ ë‚ ì§œì˜ ì°¨ëŸ‰ ìˆœë²ˆ ì‚¬ìš©
    const D = dayOffset(S.year, S.month, day);
    storeVal = posOfVehicle(dr.vehicle, D) || weekNum;
  } else if(dr && (!dr.vehicle||dr.vehicle==='')){
    // í˜ì–´: íŒŒíŠ¸ë„ˆì™€ ë™ì¼ ìˆœë²ˆ
    const pairDr = S.drivers.find(p=>p.id===dr.id-1&&p.active);
    const pairVal = pairDr ? getCellVal(S.year,S.month,pairDr.id,day) : null;
    storeVal = pairVal !== null ? pairVal : weekNum;
  } else {
    storeVal = weekNum; // SP: ì£¼ê°„ ì¹´ìš´íŠ¸ ì €ì¥
  }
  _pendingCellVal = storeVal;
  document.querySelectorAll('.seq-btn').forEach(b=>b.classList.remove('active-sel'));
  (e||event).currentTarget.classList.add('active-sel');
}
function setCell(v,e){
  _pendingCellVal = v;
  const evt = e||event;
  if(v===null){
    document.querySelectorAll('.seq-btn').forEach(b=>b.classList.remove('active-sel'));
    document.querySelectorAll('.sp-btn,.clear-btn').forEach(b=>b.classList.remove('active-sel'));
    evt.currentTarget.classList.add('active-sel');
  } else {
    document.querySelectorAll('.seq-btn').forEach(b=>b.classList.remove('active-sel'));
    evt.currentTarget.classList.add('active-sel');
  }
}

function saveCell(){
  if(!S.editCell) {closeModal('cellModal');return;}
  const {driverId, day} = S.editCell;
  const newNote = document.getElementById('cellNoteInput').value.trim();
  const oldVal = getCellVal(S.year,S.month,driverId,day);
  const oldNote = getCellNote(S.year,S.month,driverId,day);

  // push to history
  S.history.push({key:schedKey(S.year,S.month),driverId,day,oldVal,oldNote});
  if(S.history.length>100) S.history.shift();

  if(_pendingCellVal !== undefined && _pendingCellVal !== null){
    setCellVal(S.year,S.month,driverId,day,_pendingCellVal);
    unmarkCleared(S.year,S.month,driverId,day);
    // ê°’ì´ ì„¤ì •ë˜ë©´ â†’ í•´ë‹¹ ë‚  ë¹¨ê°„ ê³µì„ í•˜ë‚˜ ìë™ í•´ì†Œ (ëª¨ë“  ìš´ì „ì íƒ€ì…)
    if(oldVal===null){
      const mcKey = schedKey(S.year,S.month);
      if(S.manuallyCleared[mcKey]){
        const toRemove = Object.keys(S.manuallyCleared[mcKey]).find(k=>k.endsWith(':'+day));
        if(toRemove) delete S.manuallyCleared[mcKey][toRemove];
      }
    }
  } else if(_pendingCellVal === null){
    setCellVal(S.year,S.month,driverId,day,null);
    markCleared(S.year,S.month,driverId,day,oldVal);
    // shiftOverride í•´ì†Œ
    const oKey = schedKey(S.year,S.month);
    if(S.shiftOverrides[oKey]) delete S.shiftOverrides[oKey][driverId+':'+day];
  }
  setCellNote(S.year,S.month,driverId,day,newNote);

  _pendingCellVal = undefined;
  closeModal('cellModal');
  saveToStorage();
  renderMonthlySchedule();
  renderStats();
  updateUndoBtn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì‹¤í–‰ ì·¨ì†Œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function undoAction(){
  if(S.history.length===0) return;
  const h = S.history.pop();
  setCellVal(S.year,S.month,h.driverId,h.day,h.oldVal);
  setCellNote(S.year,S.month,h.driverId,h.day,h.oldNote);
  // wasCleared í”Œë˜ê·¸: performAssignmentì—ì„œ í•´ì†Œëœ ê³µì„ ë³µêµ¬
  if(h.wasCleared){
    markCleared(S.year,S.month,h.driverId,h.day);
  } else {
    unmarkCleared(S.year,S.month,h.driverId,h.day);
  }
  // shiftOverride í•´ì†Œ
  if(h.hadOverride){
    const oKey = schedKey(S.year,S.month);
    if(S.shiftOverrides[oKey]) delete S.shiftOverrides[oKey][h.overrideDriverId+':'+h.overrideDay];
  }
  saveToStorage();
  renderMonthlySchedule();
  renderStats();
  updateUndoBtn();
  showStatus('ì‹¤í–‰ ì·¨ì†Œë¨');
}
function updateUndoBtn(){
  const has = S.history.length>0;
  ['undoBtn','undoBtn2'].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.disabled = !has;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë“œë˜ê·¸ ì„ íƒ (ë‹¤ì¤‘ ì…€)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDrag(driverId,day){
  S.dragStart = {driverId,day};
  S.dragCells = [{driverId,day}];
}
function updateDrag(driverId,day){
  if(!S.dragStart) return;
  if(driverId===S.dragStart.driverId && day !== S.dragStart.day){
    const mn = Math.min(S.dragStart.day,day), mx = Math.max(S.dragStart.day,day);
    S.dragCells = [];
    for(let d=mn;d<=mx;d++) S.dragCells.push({driverId,day:d});
  }
}
document.addEventListener('mouseup',()=>{
  if(S.dragStart && S.dragCells.length>1){
    openRangeModal();
  }
  S.dragStart = null;
});

function openRangeModal(){
  const first = S.dragCells[0];
  const dr = S.drivers.find(d=>d.id===first.driverId);
  if(!dr) return;
  const days = S.dragCells.map(c=>c.day);
  document.getElementById('rangeCtx').innerHTML =
    `<b>${dr.name}</b> â€” ${Math.min(...days)}ì¼~${Math.max(...days)}ì¼ (${S.dragCells.length}ì¼)`;
  openModal('rangeModal');
}

function rangeAction(type){
  S.dragCells.forEach(({driverId,day})=>{
    const oldVal = getCellVal(S.year,S.month,driverId,day);
    const oldNote = getCellNote(S.year,S.month,driverId,day);
    S.history.push({key:schedKey(S.year,S.month),driverId,day,oldVal,oldNote});
    if(type==='clear'){
      setCellVal(S.year,S.month,driverId,day,null);
      setCellNote(S.year,S.month,driverId,day,'');
    } else {
      setCellVal(S.year,S.month,driverId,day,null);
      setCellNote(S.year,S.month,driverId,day,type);
    }
    markCleared(S.year,S.month,driverId,day,oldVal);
    // shiftOverride í•´ì†Œ
    const oKey = schedKey(S.year,S.month);
    if(S.shiftOverrides[oKey]) delete S.shiftOverrides[oKey][driverId+':'+day];
  });
  closeModal('rangeModal');
  S.dragCells=[];
  saveToStorage();
  renderMonthlySchedule();
  renderStats();
  updateUndoBtn();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì£¼ê°„ ë°°ì°¨í‘œ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWeeksInMonth(y,m){
  const days = daysInMonth(y,m);
  const weeks = [];
  let weekNum = 1, start = 1;
  while(start<=days){
    const startDow = dayOfWeek(y,m,start);
    // ì£¼ ì‹œì‘ì€ ì›”ìš”ì¼(1)
    let end = start;
    // ì´ë²ˆ ì£¼ ë§ˆì§€ë§‰ ë‚  (ì¼ìš”ì¼ ë˜ëŠ” ì›”ë§)
    while(end<days && dayOfWeek(y,m,end+1)!==1) end++;
    weeks.push({week:weekNum, start, end});
    weekNum++;
    start = end+1;
  }
  return weeks;
}

function renderWeekTabs(){
  const weeks = getWeeksInMonth(S.year,S.month);
  let html = '';
  weeks.forEach(w=>{
    const cls = S.currentWeek===w.week ? 'active':'';
    html += `<button class="week-tab ${cls}" onclick="selectWeek(${w.week})">${S.month}ì›” ${w.week}ì£¼ (${w.start}ì¼~${w.end}ì¼)</button>`;
  });
  document.getElementById('weekTabs').innerHTML = html;
}

function selectWeek(n){
  S.currentWeek = n;
  renderWeekTabs();
  renderWeeklyDispatch();
}

function renderWeeklyDispatch(){
  const y=S.year,m=S.month;
  const weeks = getWeeksInMonth(y,m);
  const wk = weeks.find(w=>w.week===S.currentWeek);
  if(!wk){document.getElementById('weeklyDispatchTable').innerHTML='';return;}

  document.getElementById('weeklyTitle').textContent = `${y}ë…„ ${m}ì›” ${S.currentWeek}ì£¼ì°¨ ë°°ì°¨í‘œ`;

  let html = `<div style="overflow-x:auto;"><table class="dispatch-table">`;

  for(let d=wk.start;d<=wk.end;d++){
    const dn = dayName(y,m,d);
    const D = dayOffset(y,m,d);

    // Day header
    html += `<tr><td class="dh-day" colspan="9">ğŸ“… ${m}ì›” ${d}ì¼ (${dn})</td></tr>`;
    html += `<tr>
      <td class="dh-col">ìˆœë²ˆ</td><td class="dh-col">ì°¨ëŸ‰</td>
      <td class="dh-col">ì˜¤ì „ ê·¼ë¬´ì</td><td class="dh-col">1íšŒì°¨</td><td class="dh-col">2íšŒì°¨</td>
      <td class="dh-col">ì˜¤í›„ ê·¼ë¬´ì</td><td class="dh-col">1íšŒì°¨</td><td class="dh-col">2íšŒì°¨</td><td class="dh-col">3íšŒì°¨</td>
    </tr>`;

    const maxSeq = maxSeqForDay(y,m,d);
    const dayTimes = getScheduleTimes(y,m,d);
    for(let seq=1;seq<=maxSeq;seq++){
      const veh = vehicleAtPos(seq,D);
      const times = dayTimes[seq-1]||EMPTY_TIMES;
      // í•´ë‹¹ ìˆœë²ˆ ë°°ì •ëœ ìš´ì „ì ì°¾ê¸° (ì°¨ëŸ‰ ê³ ì • ë“œë¼ì´ë²„ ìš°ì„ , SP ë³´ì¡°)
      const assignedDrivers = S.drivers.filter(dr=>{
        if(!dr.active) return false;
        const v = getCellVal(y,m,dr.id,d);
        return v===seq || v===String(seq);
      });
      const amDriver = assignedDrivers.find(dr=>getShiftForDay(y,m,dr.id,d)==='AM')||assignedDrivers[0];
      const pmDriver = assignedDrivers.find(dr=>getShiftForDay(y,m,dr.id,d)==='PM')||assignedDrivers[1];

      html += `<tr>
        <td class="dam-row"><b>${seq}</b></td>
        <td class="dam-row">${veh}</td>
        <td class="dam-row">${amDriver?amDriver.name:''}</td>
        <td class="dam-row">${times.am1}</td>
        <td class="dam-row">${times.am2}</td>
        <td class="dpm-row">${pmDriver?pmDriver.name:''}</td>
        <td class="dpm-row">${times.pm1}</td>
        <td class="dpm-row">${times.pm2}</td>
        <td class="dpm-row">${times.pm3||'-'}</td>
      </tr>`;
    }

    // í‰ì¼ ì˜¤ì „ í¸ë„(ìˆ˜) ì°¨ëŸ‰ â€” ì›”~ê¸ˆ ë§¤ì¼
    if(!isSat(y,m,d) && !isSun(y,m,d)){
      const suDrivers = S.drivers.filter(dr=>{ if(!dr.active) return false; return getCellVal(y,m,dr.id,d)==='ìˆ˜'; });
      html += `<tr><td class="dw-row" colspan="9"><b>ğŸŸ¢ í‰ì¼ í¸ë„(ìˆ˜) ì°¨ëŸ‰ â€” ê·¼ë¬´ì: ${suDrivers.map(d=>d.name).join(', ')||'ë¯¸ë°°ì •'}</b></td></tr>`;
      WED_VEHICLES.forEach((wv,wi)=>{
        const assignedName = suDrivers[wi] ? suDrivers[wi].name : 'ë¯¸ë°°ì •';
        html += `<tr>
          <td class="dw-row">ìˆ˜</td><td class="dw-row">${wv.num}</td>
          <td class="dw-row" colspan="2">${assignedName}</td>
          <td class="dw-row">${wv.am1}</td><td class="dw-row">${wv.am2}</td>
          <td class="dw-row" colspan="3">í¸ë„(ì˜¤ì „)</td>
        </tr>`;
      });
    }

    html += `<tr><td colspan="9" style="height:8px;background:#f0f2f5;border:none;"></td></tr>`;
  }

  html += `</table></div>`;
  document.getElementById('weeklyDispatchTable').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§ì› ê´€ë¦¬ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEmployeeTable(){
  const active = S.drivers.filter(dr=>dr.active);
  let html = `<table class="emp-table"><thead><tr>
    <th>ë²ˆí˜¸</th><th>ì„±ëª…</th><th>ì°¨ëŸ‰ë²ˆí˜¸</th><th>íœ´ë¬´ìš”ì¼</th><th>íœ´ë¬´ìš”ì¼(-1)</th><th>íŠ¹ì´ì‚¬í•­</th><th>í¸ì§‘</th>
  </tr></thead><tbody>`;

  active.forEach(dr=>{
    let empVeh = dr.vehicle || '';
    if(!empVeh || empVeh===''){
      const p = S.drivers.find(pp=>pp.id===dr.id-1&&pp.active);
      empVeh = p ? (p.vehicle||'-') : '-';
    }
    html += `<tr>
      <td>${dr.seq||dr.id}</td>
      <td><b>${dr.name}</b></td>
      <td>${empVeh}</td>
      <td>${dr.dayOff}</td>
      <td>${dr.preDayOff||DAYNAMES[(DAYNAMES.indexOf(dr.dayOff)+6)%7]}</td>
      <td style="font-size:14px;color:#666;">${dr.note||''}</td>
      <td>
        <button class="btn btn-info btn-sm" onclick="openEditEmployee(${dr.id})">âœï¸ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="deactivateEmployee(${dr.id})" style="margin-left:4px;">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;

  // â”€â”€ ë¹„í™œì„±(ì‚­ì œ) ì§ì› í•˜ë‹¨ í‘œì‹œ â”€â”€
  const inactive = S.drivers.filter(dr=>!dr.active);
  if(inactive.length > 0){
    html += `<h3 style="margin-top:24px;color:#888;border-bottom:2px solid #ddd;padding-bottom:8px;">ë¹„í™œì„± ì§ì› (${inactive.length}ëª…)</h3>`;
    html += `<table class="emp-table" style="opacity:0.7;"><thead><tr>
      <th>ë²ˆí˜¸</th><th>ì„±ëª…</th><th>ì°¨ëŸ‰ë²ˆí˜¸</th><th>íœ´ë¬´ìš”ì¼</th><th>íœ´ë¬´ìš”ì¼(-1)</th><th>íŠ¹ì´ì‚¬í•­</th><th>ê´€ë¦¬</th>
    </tr></thead><tbody>`;
    inactive.forEach(dr=>{
      let iVeh = dr.vehicle || '';
      if(!iVeh || iVeh===''){
        const ip = S.drivers.find(pp=>pp.id===dr.id-1);
        iVeh = ip ? (ip.vehicle||'-') : '-';
      }
      html += `<tr style="background:#f5f5f5;">
        <td>${dr.seq||dr.id}</td>
        <td><b style="color:#999;">${dr.name}</b></td>
        <td>${iVeh}</td>
        <td>${dr.dayOff}</td>
        <td>${dr.preDayOff||DAYNAMES[(DAYNAMES.indexOf(dr.dayOff)+6)%7]}</td>
        <td style="font-size:14px;color:#999;">${dr.note||''}</td>
        <td>
          <button class="btn btn-success btn-sm" onclick="reactivateEmployee(${dr.id})">ì¬í™œì„±í™”</button>
          <button class="btn btn-danger btn-sm" onclick="permanentDeleteEmployee(${dr.id})" style="margin-left:4px;">ì™„ì „ì‚­ì œ</button>
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }

  document.getElementById('employeeTable').innerHTML = html;
}

function autoFillPreDayOff(){
  const dayOff = document.getElementById('empDayOff').value;
  const idx = DAYNAMES.indexOf(dayOff);
  document.getElementById('empPreDayOff').value = DAYNAMES[(idx+6)%7];
}

function openAddEmployee(){
  document.getElementById('empId').value = '';
  document.getElementById('empSeq').value = '';
  document.getElementById('empName').value = '';
  document.getElementById('empVehicle').value = '';
  document.getElementById('empDayOff').value = 'ì›”';
  document.getElementById('empPreDayOff').value = 'ì¼';
  document.getElementById('empNote').value = '';
  document.getElementById('empModalTitle').textContent = 'ì§ì› ì¶”ê°€';
  openModal('empModal');
}

function openEditEmployee(id){
  const dr = S.drivers.find(d=>d.id===id);
  if(!dr) return;
  document.getElementById('empId').value = id;
  document.getElementById('empSeq').value = dr.seq||dr.id;
  document.getElementById('empName').value = dr.name;
  document.getElementById('empVehicle').value = dr.vehicle||'';
  document.getElementById('empDayOff').value = dr.dayOff;
  document.getElementById('empPreDayOff').value = dr.preDayOff || DAYNAMES[(DAYNAMES.indexOf(dr.dayOff)+6)%7];
  document.getElementById('empNote').value = dr.note||'';
  document.getElementById('empModalTitle').textContent = `ì§ì› ìˆ˜ì • â€” ${dr.name}`;
  openModal('empModal');
}

function saveEmployee(){
  const id = document.getElementById('empId').value;
  const name = document.getElementById('empName').value.trim();
  if(!name){alert('ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const seqVal = parseInt(document.getElementById('empSeq').value) || null;
  const veh = document.getElementById('empVehicle').value.trim();
  const dayOff = document.getElementById('empDayOff').value;
  const preDayOff = document.getElementById('empPreDayOff').value;
  const note = document.getElementById('empNote').value.trim();
  // shiftëŠ” ì°¨ëŸ‰ ìœ ë¬´ë¡œ ìë™ ê²°ì •
  const shift = (veh && veh!=='' && veh!=='SP') ? 'ì˜¤ì „' : (!veh || veh==='') ? 'ì˜¤í›„' : 'ì˜¤ì „';

  if(id){
    const dr = S.drivers.find(d=>d.id===parseInt(id));
    if(dr){
      dr.name=name; dr.vehicle=veh; dr.dayOff=dayOff; dr.preDayOff=preDayOff;
      dr.shift=shift; dr.note=note;
      if(seqVal) dr.seq = seqVal;
    }
  } else {
    const newId = Math.max(...S.drivers.map(d=>d.id),0)+1;
    S.drivers.push({id:newId, seq:seqVal||newId, name,vehicle:veh,dayOff,preDayOff,shift,note,active:true});
  }
  S.drivers.sort((a,b)=>(a.seq||a.id)-(b.seq||b.id));
  closeModal('empModal');
  saveToStorage();
  renderEmployeeTable();
  renderRotationGrid();
  renderMonthlySchedule();
  renderStats();
  showStatus('ì§ì› ì •ë³´ ì €ì¥ë¨');
}

function deactivateEmployee(id){
  showConfirm('ì´ ì§ì›ì„ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', ()=>{
    const dr = S.drivers.find(d=>d.id===id);
    if(dr) dr.active=false;
    saveToStorage();
    renderEmployeeTable();
    showStatus('ì§ì› ë¹„í™œì„±í™”ë¨');
  });
}

function reactivateEmployee(id){
  showConfirm('ì´ ì§ì›ì„ ì¬í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', ()=>{
    const dr = S.drivers.find(d=>d.id===id);
    if(dr) dr.active=true;
    saveToStorage();
    renderEmployeeTable();
    renderMonthlySchedule();
    renderStats();
    showStatus('ì§ì› ì¬í™œì„±í™”ë¨');
  });
}

function permanentDeleteEmployee(id){
  showConfirm('ì´ ì§ì›ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><small>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>', ()=>{
    S.drivers = S.drivers.filter(d=>d.id!==id);
    saveToStorage();
    renderEmployeeTable();
    showStatus('ì§ì› ì˜êµ¬ ì‚­ì œë¨');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì°¨ëŸ‰ ê´€ë¦¬ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVehicleTable(){
  let html = `<table class="emp-table" style="max-width:700px;"><thead>
    <tr><th>ìˆœë²ˆ(ê¸°ì¤€ì¼)</th><th>ì°¨ëŸ‰ë²ˆí˜¸</th><th>ë°°ì • ìš´ì „ì</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr>
  </thead><tbody>`;
  S.baseOrder.forEach((veh,i)=>{
    const dr = S.drivers.find(d=>d.vehicle===veh&&d.active);
    const pairDr = dr ? S.drivers.find(d=>d.id===dr.id+1&&d.active) : null;
    const names = [dr?dr.name:'-', pairDr?pairDr.name:''].filter(n=>n&&n!=='-').join(' / ');
    html += `<tr>
      <td><b>${i+1}</b></td>
      <td><b>${veh}</b></td>
      <td>${names||'-'}</td>
      <td style="font-size:14px;color:#777;">${veh==='SP'?'ì˜ˆë¹„ì°¨ëŸ‰':''}</td>
      <td><button class="btn btn-info btn-sm" onclick="openEditVehicle(${i})">ìˆ˜ì •</button></td>
    </tr>`;
  });
  // ìˆ˜ìš” ì „ìš© ì°¨ëŸ‰
  WED_VEHICLES.forEach(wv=>{
    html += `<tr>
      <td style="background:#e8ffe8;">ìˆ˜ìš”</td>
      <td style="background:#e8ffe8;"><b>${wv.num}</b></td>
      <td style="background:#e8ffe8;">-</td>
      <td style="background:#e8ffe8;font-size:14px;">ìˆ˜ìš”ì¼ ì „ìš© (ì˜¤ì „ë§Œ)</td>
    </tr>`;
  });
  html += `</tbody></table>`;

  // ìš´í–‰ ì‹œê°í‘œ
  html += `<br><h3 style="color:#1a3a6b;margin-bottom:8px;">ğŸ“‹ ìˆœë²ˆë³„ ìš´í–‰ ì‹œê°í‘œ</h3>`;
  html += `<table class="emp-table" style="max-width:700px;"><thead>
    <tr><th>ìˆœë²ˆ</th><th>ì˜¤ì „1íšŒì°¨</th><th>ì˜¤ì „2íšŒì°¨</th><th>ì˜¤í›„1íšŒì°¨</th><th>ì˜¤í›„2íšŒì°¨</th><th>ì˜¤í›„3íšŒì°¨</th></tr>
  </thead><tbody>`;
  SCHEDULE_TIMES.forEach(t=>{
    html += `<tr>
      <td><b>${t.seq}</b></td>
      <td>${t.am1}</td><td>${t.am2}</td>
      <td>${t.pm1}</td><td>${t.pm2}</td><td>${t.pm3||'â€”'}</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('vehicleTable').innerHTML = html;
}

function openEditVehicle(idx){
  const veh = S.baseOrder[idx];
  document.getElementById('vehEditIdx').value = idx;
  document.getElementById('vehEditTitle').textContent = `ì°¨ëŸ‰ ${veh} ìš´ì „ì ìˆ˜ì •`;
  // í˜„ì¬ ë°°ì •ëœ ì£¼/ë¶€ ìš´ì „ì ì°¾ê¸°
  const curMain = S.drivers.find(d=>d.vehicle===veh && d.active && d.id%2===1);
  const curPair = S.drivers.find(d=>d.vehicle===veh && d.active && d.id%2===0);
  // ì„ íƒ ê°€ëŠ¥í•œ ìš´ì „ì ëª©ë¡ êµ¬ì„± (ë¯¸ë°°ì • + í˜„ì¬ ë°°ì •ì)
  const mainSel = document.getElementById('vehEditMain');
  const pairSel = document.getElementById('vehEditPair');
  let mainHtml = '<option value="">ë¯¸ë°°ì •</option>';
  let pairHtml = '<option value="">ë¯¸ë°°ì •</option>';
  S.drivers.filter(d=>d.active).forEach(d=>{
    const isAssigned = d.vehicle && d.vehicle!=='' && d.vehicle!=='SP' && d.vehicle!==veh;
    const label = `${d.name} (${d.id})${isAssigned?' ['+d.vehicle+']':''}`;
    if(d.id%2===1){
      const sel = curMain && curMain.id===d.id ? ' selected' : '';
      mainHtml += `<option value="${d.id}"${sel}>${label}</option>`;
    } else {
      const sel = curPair && curPair.id===d.id ? ' selected' : '';
      pairHtml += `<option value="${d.id}"${sel}>${label}</option>`;
    }
  });
  mainSel.innerHTML = mainHtml;
  pairSel.innerHTML = pairHtml;
  openModal('vehModal');
}

function saveVehicleEdit(){
  const idx = parseInt(document.getElementById('vehEditIdx').value);
  const veh = S.baseOrder[idx];
  const newMainId = document.getElementById('vehEditMain').value ? parseInt(document.getElementById('vehEditMain').value) : null;
  const newPairId = document.getElementById('vehEditPair').value ? parseInt(document.getElementById('vehEditPair').value) : null;
  // ê¸°ì¡´ ë°°ì • í•´ì œ
  S.drivers.forEach(dr=>{
    if(dr.vehicle===veh){ dr.vehicle = ''; }
  });
  // ìƒˆ ë°°ì •
  if(newMainId){
    const dr = S.drivers.find(d=>d.id===newMainId);
    if(dr) dr.vehicle = veh;
  }
  if(newPairId){
    const dr = S.drivers.find(d=>d.id===newPairId);
    if(dr) dr.vehicle = veh;
  }
  closeModal('vehModal');
  saveToStorage();
  renderVehicleTable();
  renderRotationGrid();
  renderEmployeeTable();
  renderMonthlySchedule();
  showStatus(`ì°¨ëŸ‰ ${veh} ìš´ì „ì ë³€ê²½ë¨`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì„¤ì • ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRotationGrid(){
  document.getElementById('baseDateInput').value = S.baseDate;

  let html = '';
  for(let i=0;i<16;i++){
    const veh = S.baseOrder[i];
    const opts = DEFAULT_BASE_VEHICLES.map(v=>`<option value="${v}" ${v===veh?'selected':''}>${v}</option>`).join('');
    html += `<div class="rot-cell">
      <span class="rot-pos">${i+1}</span>
      <select class="rot-select" id="rot_${i}" onchange="updateRotation(${i},this.value)">${opts}</select>
    </div>`;
  }
  document.getElementById('rotationGrid').innerHTML = html;

}

function updateRotation(idx, val){
  S.baseOrder[idx] = val;
}

function saveSettings(){
  S.baseDate = document.getElementById('baseDateInput').value;
  for(let i=0;i<16;i++){
    const sel = document.getElementById(`rot_${i}`);
    if(sel) S.baseOrder[i] = sel.value;
  }
  saveToStorage();
  renderMonthlySchedule();
  renderStats();
  showStatus('ì„¤ì • ì €ì¥ë¨');
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¼ë¬´í‘œê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.');
}

function resetToDefault(){
  showConfirm('ë¡œí…Œì´ì…˜ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', ()=>{
    S.baseOrder = [...DEFAULT_BASE_VEHICLES];
    S.baseDate = '2026-01-01';
    renderRotationGrid();
    saveToStorage();
    showStatus('ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë¨');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì›”/íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeMonth(delta){
  S.month += delta;
  if(S.month>12){S.month=1;S.year++;}
  if(S.month<1){S.month=12;S.year--;}
  S.currentWeek = 1;
  S.history = [];
  updateUndoBtn();
  refreshAll();
}
function goToToday(){
  const now = new Date();
  S.year = now.getFullYear();
  S.month = now.getMonth()+1;
  refreshAll();
}
function switchTab(tab){
  S.activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('tab-content-'+tab).classList.add('active');
  if(tab==='monthly'){renderMonthlySchedule();renderStats();}
  else if(tab==='weekly'){renderWeekTabs();renderWeeklyDispatch();}
  else if(tab==='employees'){renderEmployeeTable();}
  else if(tab==='vehicles'){renderVehicleTable();}
  else if(tab==='settings'){renderRotationGrid();}
}

function refreshAll(){
  document.getElementById('monthDisplay').textContent = `${S.year}ë…„ ${S.month}ì›”`;
  if(S.activeTab==='monthly'){renderMonthlySchedule();renderStats();}
  else if(S.activeTab==='weekly'){renderWeekTabs();renderWeeklyDispatch();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ëª¨ë‹¬ ìœ í‹¸ë¦¬í‹°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');if(id==='cellModal'){_pendingCellVal=undefined;}}
// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.querySelectorAll('.modal-bg').forEach(bg=>{
  bg.addEventListener('click',e=>{if(e.target===bg) bg.classList.remove('open');});
});

let _confirmCb = null;
function showConfirm(msg, cb){
  _confirmCb = cb;
  document.getElementById('confirmMsg').innerHTML = msg;
  openModal('confirmModal');
}
document.getElementById('confirmOkBtn').onclick = ()=>{
  closeModal('confirmModal');
  if(_confirmCb){_confirmCb();_confirmCb=null;}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase + localStorage ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _getStateSnapshot(){
  return {
    drivers: S.drivers, baseDate: S.baseDate, baseOrder: S.baseOrder,
    scheduleData: S.scheduleData, notesData: S.notesData,
    manuallyCleared: S.manuallyCleared, shiftOverrides: S.shiftOverrides
  };
}
function _applyState(data){
  if(data.drivers) S.drivers = data.drivers;
  if(data.baseDate) S.baseDate = data.baseDate;
  if(data.baseOrder) S.baseOrder = data.baseOrder;
  if(data.scheduleData) S.scheduleData = data.scheduleData;
  if(data.notesData) S.notesData = data.notesData;
  if(data.manuallyCleared) S.manuallyCleared = data.manuallyCleared;
  if(data.shiftOverrides) S.shiftOverrides = data.shiftOverrides;
}
function _fixStringNumbers(){
  Object.values(S.scheduleData).forEach(monthData=>{
    Object.values(monthData).forEach(driverData=>{
      Object.keys(driverData).forEach(day=>{
        const v = driverData[day];
        if(v !== null && v !== 'ìˆ˜' && typeof v === 'string' && !isNaN(parseInt(v))){
          driverData[day] = parseInt(v);
        }
      });
    });
  });
}

function saveToStorage(){
  try{
    const json = JSON.stringify(_getStateSnapshot());
    // localStorage ë°±ì—…
    localStorage.setItem('m5121_state', json);
    // Firebase í´ë¼ìš°ë“œ ì €ì¥
    fbDb.ref('m5121/state').set(json).then(()=>{
      showStatus('í´ë¼ìš°ë“œ ì €ì¥ ì™„ë£Œ âœ“');
    }).catch(e=>{
      showStatus('í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ë¨): '+e.message);
    });
  }catch(e){showStatus('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
}

async function loadFromStorage(){
  try{
    // 1) Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
    const snapshot = await fbDb.ref('m5121/state').once('value');
    const fbData = snapshot.val();
    if(fbData){
      const data = JSON.parse(fbData);
      _applyState(data);
      _fixStringNumbers();
      console.log('Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
      return;
    }
  }catch(e){
    console.warn('Firebase ë¡œë“œ ì‹¤íŒ¨, localStorage ì‹œë„:', e.message);
  }
  try{
    // 2) Firebase ì‹¤íŒ¨ ì‹œ localStorage í´ë°±
    const local = localStorage.getItem('m5121_state');
    if(local){
      _applyState(JSON.parse(local));
      _fixStringNumbers();
      console.log('localStorageì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
      return;
    }
    // 3) ê¸°ì¡´ í˜•ì‹ localStorage í˜¸í™˜ (ë§ˆì´ê·¸ë ˆì´ì…˜)
    const drivers = localStorage.getItem('m5121_drivers');
    if(drivers) S.drivers = JSON.parse(drivers);
    const base = localStorage.getItem('m5121_baseDate');
    if(base) S.baseDate = base;
    const order = localStorage.getItem('m5121_baseOrder');
    if(order) S.baseOrder = JSON.parse(order);
    const sched = localStorage.getItem('m5121_scheduleData');
    if(sched) S.scheduleData = JSON.parse(sched);
    const notes = localStorage.getItem('m5121_notesData');
    if(notes) S.notesData = JSON.parse(notes);
    const mc = localStorage.getItem('m5121_manuallyCleared');
    if(mc) S.manuallyCleared = JSON.parse(mc);
    _fixStringNumbers();
    if(drivers) console.log('ê¸°ì¡´ localStorageì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
  }catch(e){console.error('loadFromStorage error:',e);}
}
function saveAll(){saveToStorage();}

function clearMonth(){
  showConfirm(`${S.month}ì›” ê·¼ë¬´í‘œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, ()=>{
    const key = schedKey(S.year,S.month);
    S.scheduleData[key] = {};
    S.notesData[key] = {};
    S.manuallyCleared[key] = {};
    S.history = [];
    updateUndoBtn();
    saveToStorage();
    renderMonthlySchedule();
    renderStats();
    showStatus('ì´ë²ˆë‹¬ ì´ˆê¸°í™”ë¨');
  });
}

function clearAllData(){
  showConfirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ()=>{
    localStorage.clear();
    fbDb.ref('m5121/state').remove().then(()=>location.reload()).catch(()=>location.reload());
  });
}

function exportAllData(){
  const data = {
    drivers: S.drivers, baseDate: S.baseDate, baseOrder: S.baseOrder,
    scheduleData: S.scheduleData, notesData: S.notesData,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=`M5121_ë°ì´í„°_${S.year}${String(S.month).padStart(2,'0')}.json`;
  a.click(); URL.revokeObjectURL(url);
}

function importData(){document.getElementById('importFile').click();}
function handleImport(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(data.drivers) S.drivers = data.drivers;
      if(data.baseDate) S.baseDate = data.baseDate;
      if(data.baseOrder) S.baseOrder = data.baseOrder;
      if(data.scheduleData) S.scheduleData = data.scheduleData;
      if(data.notesData) S.notesData = data.notesData;
      saveToStorage();
      refreshAll();
      alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }catch(err){alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: '+err.message);}
  };
  reader.readAsText(file);
  e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (SheetJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel(){
  showLoading('ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...');
  setTimeout(()=>{
    try{
      const wb = XLSX.utils.book_new();
      const y=S.year, m=S.month;
      const days = daysInMonth(y,m);

      // í—¤ë”
      const header1 = [`${y}ë…„ ${m}ì›”`,...Array(days+9).fill('')];
      const header2 = ['M5121 ê·¼ë¬´í‘œ',...Array(days+9).fill('')];
      const header3 = ['ë²ˆí˜¸','ì°¨ëŸ‰ë²ˆí˜¸','ì„±ëª…','íœ´ë¬´','ì¡°'];
      for(let d=1;d<=days;d++) header3.push(`${d}ì¼`);
      header3.push('','ë§Œê·¼ìˆ˜','ì´ê·¼ë¬´','ìˆ˜í•©','ì´ˆê³¼','íŠ¹ì´ì‚¬í•­','íšŒì‚¬ë§Œê·¼');
      const header4 = ['','','','',' '];
      for(let d=1;d<=days;d++) header4.push(dayName(y,m,d));
      header4.push('','','','','','','');

      const aoa = [header1, header2, header3, header4];

      S.drivers.filter(dr=>dr.active).forEach(dr=>{
        const row = [dr.id, dr.vehicle||'', dr.name, dr.dayOff, dr.preDayOff||''];
        for(let d=1;d<=days;d++){
          const val = getCellVal(y,m,dr.id,d);
          const dn = dayName(y,m,d);
          if(dn===dr.dayOff){row.push('');}
          else if(val==='ìˆ˜'){row.push('ìˆ˜');}
          else if(val!==null&&val!==undefined){row.push(val);}
          else{row.push('');}
        }
        const stats = calcDriverStats(y,m,dr.id);
        row.push('',''); // ë³‘í•© ë¹ˆì¹¸
        row.push(stats.fullWork, stats.totalWork, stats.suCount,
                 stats.over>0?'+'+stats.over:String(stats.over),
                 dr.note||'', stats.compFW);
        aoa.push(row);
      });

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = [{wch:6},{wch:8},{wch:9},{wch:5},{wch:5},...Array(days).fill({wch:4}),...Array(7).fill({wch:7})];
      XLSX.utils.book_append_sheet(wb, ws, `${m}ì›”ê·¼ë¬´í‘œ`);

      const fname = `M5121_${y}ë…„_${m}ì›”_ê·¼ë¬´í‘œ.xlsx`;
      XLSX.writeFile(wb, fname);
      showStatus(`${fname} ì €ì¥ë¨`);
    }catch(e){alert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: '+e.message);}
    finally{hideLoading();}
  },100);
}

// ì£¼ë°°ì°¨ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
function exportWeeklyExcel(){
  showLoading('ì£¼ë°°ì°¨í‘œ ì—‘ì…€ ìƒì„± ì¤‘...');
  setTimeout(()=>{
    try{
      const wb = XLSX.utils.book_new();
      const y=S.year,m=S.month;
      const weeks = getWeeksInMonth(y,m);

      weeks.forEach(wk=>{
        const aoa = [];
        aoa.push([`${y}ë…„ ${m}ì›” ${wk.week}ì£¼ì°¨ (${wk.start}ì¼~${wk.end}ì¼)`]);
        aoa.push(['ìˆœë²ˆ','ì°¨ëŸ‰','ì˜¤ì „ê·¼ë¬´ì','ì˜¤ì „1íšŒì°¨','ì˜¤ì „2íšŒì°¨','ì˜¤í›„ê·¼ë¬´ì','ì˜¤í›„1íšŒì°¨','ì˜¤í›„2íšŒì°¨','ì˜¤í›„3íšŒì°¨']);

        for(let d=wk.start;d<=wk.end;d++){
          const dn = dayName(y,m,d);
          const D = dayOffset(y,m,d);
          aoa.push([`â”€â”€ ${m}/${d}(${dn}) â”€â”€`,...Array(8).fill('')]);

          const mxSeq = maxSeqForDay(y,m,d);
          const dayTimes2 = getScheduleTimes(y,m,d);
          for(let seq=1;seq<=mxSeq;seq++){
            const veh = vehicleAtPos(seq,D);
            const times = dayTimes2[seq-1]||EMPTY_TIMES;
            const assigned = S.drivers.filter(dr=>{
              if(!dr.active) return false;
              const v = getCellVal(y,m,dr.id,d);
              return v===seq||v===String(seq);
            });
            const amD = assigned.find(dr=>getShiftForDay(y,m,dr.id,d)==='AM')||assigned[0];
            const pmD = assigned.find(dr=>getShiftForDay(y,m,dr.id,d)==='PM')||assigned[1];
            aoa.push([seq,veh,amD?amD.name:'',times.am1,times.am2,pmD?pmD.name:'',times.pm1,times.pm2,times.pm3||'-']);
          }
          aoa.push(Array(9).fill(''));
        }

        const ws = XLSX.utils.aoa_to_sheet(aoa);
        ws['!cols']=[{wch:5},{wch:7},{wch:9},{wch:7},{wch:7},{wch:9},{wch:7},{wch:7},{wch:7}];
        XLSX.utils.book_append_sheet(wb, ws, `${m}ì›”${wk.week}ì£¼`);
      });

      const fname = `M5121_${y}ë…„_${m}ì›”_ì£¼ë°°ì°¨í‘œ.xlsx`;
      XLSX.writeFile(wb, fname);
      showStatus(`${fname} ì €ì¥ë¨`);
    }catch(e){alert('ì˜¤ë¥˜: '+e.message);}
    finally{hideLoading();}
  },100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° (html2canvas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportCurrentDayImage(){
  const today = new Date();
  if(today.getFullYear()!==S.year||today.getMonth()+1!==S.month){
    alert('í˜„ì¬ ë³´ê³  ìˆëŠ” ë‹¬ì´ ì˜¤ëŠ˜ê³¼ ë‹¤ë¦…ë‹ˆë‹¤. ì˜¤ëŠ˜('+today.getDate()+'ì¼)ì˜ ë°°ì°¨ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
  }
  await exportDayImage(today.getDate());
}

async function exportDayImage(day){
  showLoading(`${day}ì¼ ë°°ì°¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...`);
  try{
    const y=S.year,m=S.month;
    const D = dayOffset(y,m,day);
    const dn = dayName(y,m,day);

    // ì„ì‹œ ë Œë” div
    const div = document.createElement('div');
    div.style.cssText='position:fixed;top:-9999px;left:-9999px;background:#fff;padding:16px;width:900px;';

    let html = `<div style="text-align:center;margin-bottom:12px;">
      <div style="font-size:26px;font-weight:900;color:#1a3a6b;">M5121 ë…¸ì„  ë°°ì°¨í‘œ</div>
      <div style="font-size:18px;font-weight:700;color:#333;">${y}ë…„ ${m}ì›” ${day}ì¼ (${dn})</div>
    </div>
    <table style="border-collapse:collapse;width:100%;font-size:14px;">
      <tr style="background:#1a3a6b;color:#fff;">
        <th style="border:1px solid #aaa;padding:8px;">ìˆœë²ˆ</th>
        <th style="border:1px solid #aaa;padding:8px;">ì°¨ëŸ‰</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤ì „ ê·¼ë¬´ì</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤ì „1íšŒì°¨</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤ì „2íšŒì°¨</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤í›„ ê·¼ë¬´ì</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤í›„1íšŒì°¨</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤í›„2íšŒì°¨</th>
        <th style="border:1px solid #aaa;padding:8px;">ì˜¤í›„3íšŒì°¨</th>
      </tr>`;

    const imgMaxSeq = maxSeqForDay(y,m,day);
    const imgTimes = getScheduleTimes(y,m,day);
    for(let seq=1;seq<=imgMaxSeq;seq++){
      const veh = vehicleAtPos(seq,D);
      const times = imgTimes[seq-1]||EMPTY_TIMES;
      const assigned = S.drivers.filter(dr=>{
        if(!dr.active) return false;
        const v = getCellVal(y,m,dr.id,day);
        return v===seq||v===String(seq);
      });
      const amD = assigned.find(dr=>getShiftForDay(y,m,dr.id,day)==='AM')||assigned[0];
      const pmD = assigned.find(dr=>getShiftForDay(y,m,dr.id,day)==='PM')||assigned[1];
      const bg = seq%2===0 ? '#f0f5ff':'#ffffff';
      html += `<tr style="background:${bg};">
        <td style="border:1px solid #ccc;padding:7px;text-align:center;font-weight:800;">${seq}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;font-weight:700;">${veh}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#e8f4ff;">${amD?amD.name:''}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#e8f4ff;">${times.am1}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#e8f4ff;">${times.am2}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#fff8e8;">${pmD?pmD.name:''}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#fff8e8;">${times.pm1}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#fff8e8;">${times.pm2}</td>
        <td style="border:1px solid #ccc;padding:7px;text-align:center;background:#fff8e8;">${times.pm3||'â€”'}</td>
      </tr>`;
    }
    html += `</table>
    <div style="text-align:right;font-size:11px;color:#888;margin-top:8px;">ìƒì„±: ${new Date().toLocaleString('ko-KR')}</div>`;

    div.innerHTML = html;
    document.body.appendChild(div);

    const canvas = await html2canvas(div, {scale:2, useCORS:true});
    document.body.removeChild(div);

    canvas.toBlob(blob=>{
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download=`M5121_${y}ë…„_${m}ì›”_${day}ì¼_ë°°ì°¨í‘œ.png`;
      a.click(); URL.revokeObjectURL(url);
      showStatus(`${day}ì¼ ë°°ì°¨ ì´ë¯¸ì§€ ì €ì¥ë¨`);
    });
  }catch(e){alert('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜: '+e.message);}
  finally{hideLoading();}
}

async function exportAllImages(){
  const y=S.year,m=S.month;
  const days = daysInMonth(y,m);
  showLoading('ì „ì²´ ì´ë¯¸ì§€ ZIP ìƒì„± ì¤‘...');
  try{
    const zip = new JSZip();
    const imgFolder = zip.folder(`M5121_${y}ë…„_${m}ì›”`);

    for(let day=1;day<=days;day++){
      const D = dayOffset(y,m,day);
      const dn = dayName(y,m,day);
      const div = document.createElement('div');
      div.style.cssText='position:fixed;top:-9999px;left:-9999px;background:#fff;padding:16px;width:900px;';

      let html = `<div style="text-align:center;margin-bottom:12px;">
        <div style="font-size:24px;font-weight:900;color:#1a3a6b;">M5121 ë…¸ì„  ë°°ì°¨í‘œ</div>
        <div style="font-size:17px;font-weight:700;color:#333;">${y}ë…„ ${m}ì›” ${day}ì¼ (${dn})</div>
      </div>
      <table style="border-collapse:collapse;width:100%;font-size:13px;"><tr style="background:#1a3a6b;color:#fff;">
        <th style="border:1px solid #aaa;padding:6px;">ìˆœë²ˆ</th><th style="border:1px solid #aaa;padding:6px;">ì°¨ëŸ‰</th>
        <th style="border:1px solid #aaa;padding:6px;">ì˜¤ì „ê·¼ë¬´ì</th><th style="border:1px solid #aaa;padding:6px;">ì˜¤ì „1íšŒì°¨</th><th style="border:1px solid #aaa;padding:6px;">ì˜¤ì „2íšŒì°¨</th>
        <th style="border:1px solid #aaa;padding:6px;">ì˜¤í›„ê·¼ë¬´ì</th><th style="border:1px solid #aaa;padding:6px;">ì˜¤í›„1íšŒì°¨</th><th style="border:1px solid #aaa;padding:6px;">ì˜¤í›„2íšŒì°¨</th><th style="border:1px solid #aaa;padding:6px;">ì˜¤í›„3íšŒì°¨</th>
      </tr>`;
      const zipMaxSeq = maxSeqForDay(y,m,day);
      const zipTimes = getScheduleTimes(y,m,day);
      for(let seq=1;seq<=zipMaxSeq;seq++){
        const veh = vehicleAtPos(seq,D);
        const times = zipTimes[seq-1]||EMPTY_TIMES;
        const assigned = S.drivers.filter(dr=>{
          if(!dr.active) return false;
          const v = getCellVal(y,m,dr.id,day);
          return v===seq||v===String(seq);
        });
        const amD = assigned.find(dr=>getShiftForDay(y,m,dr.id,day)==='AM')||assigned[0];
        const pmD = assigned.find(dr=>getShiftForDay(y,m,dr.id,day)==='PM')||assigned[1];
        const bg = seq%2===0?'#f0f5ff':'#fff';
        html += `<tr style="background:${bg};"><td style="border:1px solid #ccc;padding:6px;text-align:center;font-weight:800;">${seq}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;">${veh}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;background:#e8f4ff;">${amD?amD.name:''}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;">${times.am1}</td><td style="border:1px solid #ccc;padding:6px;text-align:center;">${times.am2}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;background:#fff8e8;">${pmD?pmD.name:''}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;">${times.pm1}</td><td style="border:1px solid #ccc;padding:6px;text-align:center;">${times.pm2}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;">${times.pm3||'â€”'}</td></tr>`;
      }
      html += `</table>`;
      div.innerHTML = html;
      document.body.appendChild(div);
      const canvas = await html2canvas(div, {scale:2,useCORS:true});
      document.body.removeChild(div);
      const dataUrl = canvas.toDataURL('image/png');
      const base64 = dataUrl.split(',')[1];
      imgFolder.file(`${String(day).padStart(2,'0')}_${day}ì¼(${dn}).png`, base64, {base64:true});
    }

    const zipBlob = await zip.generateAsync({type:'blob'});
    const url = URL.createObjectURL(zipBlob);
    const a = document.createElement('a'); a.href=url;
    a.download=`M5121_${y}ë…„_${m}ì›”_ë°°ì°¨ì´ë¯¸ì§€.zip`;
    a.click(); URL.revokeObjectURL(url);
    showStatus(`${days}ì¼ì¹˜ ì´ë¯¸ì§€ ZIP ì €ì¥ë¨`);
  }catch(e){alert('ì´ë¯¸ì§€ ì¼ê´„ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
  finally{hideLoading();}
}

async function exportWeeklyImages(){
  const wk = getWeeksInMonth(S.year,S.month).find(w=>w.week===S.currentWeek);
  if(!wk) return;
  const imgs = [];
  for(let d=wk.start;d<=wk.end;d++) imgs.push(d);
  for(const day of imgs) await exportDayImage(day);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìœ í‹¸ë¦¬í‹° UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showStatus(msg){
  document.getElementById('saveStatus').textContent = msg;
  setTimeout(()=>document.getElementById('saveStatus').textContent='ìë™ ì €ì¥ ì™„ë£Œ',3000);
}
function showLoading(msg='ì²˜ë¦¬ ì¤‘...'){
  document.getElementById('loadingText').textContent = msg;
  document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('show');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='z'){e.preventDefault();undoAction();}
  if((e.ctrlKey||e.metaKey) && e.key==='s'){e.preventDefault();saveAll();}
  if(e.key==='Escape'){
    document.querySelectorAll('.modal-bg.open').forEach(m=>m.classList.remove('open'));
    _pendingCellVal=undefined;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init(){
  // Firebase/localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
  await loadFromStorage();
  if(!S.drivers || S.drivers.length===0){
    S.drivers = DEFAULT_DRIVERS.map(d=>({...d}));
  }
  if(!S.baseOrder || S.baseOrder.length!==16){
    S.baseOrder = [...DEFAULT_BASE_VEHICLES];
  }

  // â”€â”€ ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ â”€â”€
  S.drivers.forEach(dr=>{
    if((!dr.vehicle||dr.vehicle==='') && dr.shift==='ì˜¤ì „'){
      const pairDr = S.drivers.find(p=>p.id===dr.id-1);
      if(pairDr && pairDr.shift==='ì˜¤ì „') dr.shift='ì˜¤í›„';
    }
    if(!dr.fullDay) dr.fullDay = dr.dayOff;
    // seq ë¯¸ì¡´ì¬ ì‹œ idë¡œ ì´ˆê¸°í™”
    if(dr.seq == null) dr.seq = dr.id;
    // preDayOff ë¯¸ì¡´ì¬ ì‹œ dayOff ì „ë‚  ìš”ì¼ë¡œ ì´ˆê¸°í™”
    if(!dr.preDayOff){
      const idx = DAYNAMES.indexOf(dr.dayOff);
      dr.preDayOff = DAYNAMES[(idx+6)%7];
    }
  });
  // shiftOverrides ë¯¸ì¡´ì¬ ì‹œ ì´ˆê¸°í™”
  if(!S.shiftOverrides) S.shiftOverrides = {};

  // í˜„ì¬ ë‚ ì§œ ê¸°ë³¸ê°’
  const now = new Date();
  S.year = now.getFullYear();
  S.month = now.getMonth()+1;

  document.getElementById('monthDisplay').textContent = `${S.year}ë…„ ${S.month}ì›”`;

  // ë Œë”ë§
  renderMonthlySchedule();
  renderStats();
  updateUndoBtn();

  console.log('M5121 ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
})();
</script>
</body>
</html>
